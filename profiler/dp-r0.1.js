(function(){function R(e,f,b,a,d){var g=b!==undefined,k=a!==undefined;b=g?b:dv.minv(e);a=k?a:dv.maxv(e);e=a-b;if(!e||!isFinite(e))return[b,b,1];e=Math.pow(10,Math.round(Math.log(e)/Math.log(10))-1);e=[Math.floor(b/e)*e,Math.ceil(a/e)*e];if(g)e[0]=b;if(k)e[1]=a;if(d===undefined){d=dv.logFloor((e[1]-e[0])/f,10);f=f/((e[1]-e[0])/d);if(f<=0.15)d*=10;else if(f<=0.35)d*=5;else if(f<=0.75)d*=2}console.log(d);e.push(d);return e}function P(e,f){if(!dp.profile.cache)return e.data.query(f);var b=f.dims,a=[],
d;keys=b.map(function(k,l){a.push(l);return k.key});a.sort(function(k,l){return keys[k]<keys[l]?-1:keys[k]>keys[l]?1:0});var g=a.map(function(k){return keys[k]}).join("__");if(!(d=e.cache[g])){b=a.map(function(k){return b[k]});d=e.data.query({dims:b,vals:f.vals,code:f.code});e.cache[g]=d}a.push(a.length);return a.map(function(k){return d[k]})}function M(e,f,b){if(e[f].type===dp.type.numeric){b=b||20;b=R(e[f],b);return dv.bin(f,b[2],b[0],b[1])}else return f}function L(e){var f,b,a=0,d=0;for(f=0;f<
e.length;++f)a+=e[f];if(a==0)return 0;for(f=0;f<e.length;++f){b=e[f]/a;if(b>0)d+=b*Math.log(b)/Math.LN2}return-d}function Q(e,f){f=f||false;var b=e[0],a=e[1];e=e[2];var d=dv.array(b.unique),g=dv.array(a.unique),k,l=0,p,m=e.length,s,n=0;for(k=0;k<m;++k){d[b[k]]+=e[k];g[a[k]]+=e[k];l+=e[k]}p=1/(l*Math.LN2);for(k=0;k<m;++k)if(e[k]!=0){s=l*e[k]/(d[b[k]]*g[a[k]]);n+=e[k]*p*Math.log(s)}if(f){d=L(d);g=L(g);return 1-n/(d>g?d:g)}else return n}function S(e,f){f=f||false;var b=e[0],a=e[1];e=e[2];var d=dv.array(b.unique),
g=dv.array(a.unique),k,l=0,p,m=e.length,s,n=0;for(k=0;k<m;++k){d[b[k]]+=e[k];g[a[k]]+=e[k];l+=e[k]}p=1/(l*Math.LN2);for(k=0;k<m;++k)if(e[k]!=0){s=l*e[k]/(d[b[k]]*g[a[k]]);n+=e[k]*p*Math.log(s)}if(f){d=L(d);g=L(g);return 1-n/(d>g?d:g)}else{d=L(d);g=L(g);return n/Math.sqrt(d*g)}}dp={};dv.EPSILON=1.0E-9;dv.logFloor=function(e,f){return e>0?Math.pow(f,Math.floor(Math.log(e)/Math.log(f))):-Math.pow(f,-Math.floor(-Math.log(-e)/Math.log(f)))};dp.profile=function(e,f,b){function a(x){var z=Date.now(),y={data:null,
cache:{}};y.data=x.filter?e.where(x.filter):undefined;y.source=x.source;for(var B=0;B<g.length;++B)g[B].is_small_multiple||(g[B]!==x.source?g[B].select(y):g[B].select({data:null}));x=Date.now();dp.profile.cycletime=x-z}function d(x){var z=x.derived_transform;A.add(z);dw.wrangle().add(z).apply([e]);x.update_dashboard&&g.map(function(y){y.update_rollup();y.update()});t({data:e})}b=b||{};var g=[],k=function(x){g.push(x);return x},l,p=0,m=dv.jq("div").attr("id","dashboard_container"),s=dv.jq("div").attr("id",
"formula_editor"),n,t=b.on_data_update,u,v=dp.selection.manager(g),A=dw.wrangle();f=jQuery(f);f.append(m);n=dp.editor.formula(s,{onupdate:d});g.selection_manager=function(){return v};g.plot=function(x,z,y,B){return k(dp[x](z,g,y,B))};g.formula_editor=function(){return n};g.default_plot=function(x,z,y){x=x||[];z=z||[];y=y||{};var B=y.graphName||(p++,"graph"+p),C=dv.jq("div").attr("id",B).addClass("chart_container"),D;m.append(C);D=dp.factory(u).default_vis(g,x,z,B,y);C.droppable({drop:function(F,H){F=
jQuery(H.helper).data("index");if(F!=undefined){if(e[F].type.type()=="numeric"&&e[x[0]].type.type()=="numeric"){g.layout().remove(D);D=g.default_plot([F],[x],{numBins:20,graphName:B});g.layout().add(D);D.plot.update()}if(e[F].type.type()=="nominal"&&e[x[0]].type.type()=="numeric"){D=g.default_plot([F],[x],{numBins:20,graphName:B});g.layout().add(D);D.plot.update()}}},greedy:true});return D};g.fields=function(){return g.reduce(function(x,z){z.fields().map(function(y){x.indexOf(y)===-1&&x.push(y)});
return x},[])};g.select=function(x,z){clearTimeout(l);z=z||1;l=setTimeout(function(){a(x)},z)};g.add_vis=function(x,z,y,B){B=B||{};B.num_bins=10;x=g.default_plot([x],[],B);z||y?g.layout().add(x,z,y):g.layout().add(x);x.plot.update()};g.clear=function(){for(var x;0<g.length;++g)if(g[0].type()==="spreadsheet"){x=g[0];break}p=g.length=0;x&&g.push(x);m.empty();u=dp.layout.naive(m,{add:g.add_vis})};g.layout=function(){return u};g.set_data=function(x){e=x;g.data=x};g.data=e;u=dp.layout.naive(m,{add:g.add_vis});
dp.selection.is_mouse_down=0;jQuery("#dashboard_container").mousedown(function(){v.current_selection(undefined);v.clear()});jQuery("body").mousedown(function(){dp.selection.is_mouse_down=1}).mouseup(function(){dp.selection.is_mouse_down=0}).keypress(function(x){if(x.keyCode===-113){v.current_selection(undefined);v.clear()}});return g};dp.profile.cache=true;(function(e){e.fn.disableSelection=function(){return this.each(function(){e(this).attr("unselectable","on").css({"-moz-user-select":"none","-webkit-user-select":"none",
"user-select":"none"}).each(function(){this.onselectstart=function(){return false}})})}})(jQuery);dp.vis=function(e,f,b,a){a=a||{};var d=dp.config.vis;f=f||this;var g={},k,l=b[0],p=k,m=a.width||200,s=a.height||594,n=d.yaxis_gutter_width||20,t=a.outer_scroll_width||0,u=a.multiples_offset||0,v=a.quality_vis_height||d.quality_bar_height||10,A=a.quality_vis_width||m,x=a.summary_vis_height||0,z=a.chart_type,y=a.quality_type,B,C,D,F,H=a.child_dom_type||"svg:svg",J=a.child_dom_type||"svg:g";if(typeOf(e)===
"string"){g.parent=function(){return jQuery("#"+e)};k=d3.select("#"+e).append(H).attr("width",m).attr("height",s)}g.container=function(){return k};g.initUI=function(){z!="spreadsheet"&&jQuery(k[0]).empty().disableSelection();k.attr("class","chart_area");B=k.append(J).attr("width",m).attr("height",s).attr("class","bordered");k.append(J);var E=k.append(J),G=k.append(J),I=k.append(J).attr("transform","translate(0, "+(v+x+1)+")"),K=k.append(J);k.append("svg:text").attr("class","title").attr("dy",d.title_y).attr("dx",
d.title_x).attr("pointer-events","none").text(b.map(function(N){var O=a.title_extra?" | "+a.title_extra.substr(1):"";return f.data[N].name()+O}).join(" vs "));C=dp.chart[z].apply(f,[I,b,dv.merge(a,{width:m-n-t,height:s-v-x,query:a.query,tick_format:a.tick_format,ext_container:k,graph_id:p,min:a.min,max:a.max,containing_vis:g})]);D=dp.quality[y].apply(f,[K,b,{width:A-n-t,height:v,query:a.query,containing_vis:g}]);menu_vis=dp.menu[z].apply(f,[G,b,{width:n,height:v,quality_width:A-n-u,chart_width:m,
graph_id:p,query:a.query,chart_vis:C,vis:g}]);if(z=="bar"||z=="grouped_bar")F=dp.scroll.bar.apply(f,[E,b,{width:n,height:s-v-x,query:a.query,chart_vis:C,vis:g}]);else if(z==="scatter")F=dp.scroll.scatter.apply(f,[E,b,{width:n,height:s-v-x,query:a.query,chart_vis:C,vis:g}])};g.initBins=function(){q={dims:[l],vals:[dv.count("*")]}};g.update_scroll=function(){F.update()};g.update=function(){C.update();D.update();F&&F.update();menu_vis.update()};g.select=function(E){if(E.source!=D&&E.source!=C){D&&D.select(E);
C.select(E)}};g.fields=function(){if(arguments.length==0)return b;b=arguments;l=b[0];return g};g.update_rollup=function(){C.update_rollup();return g};g.data=function(E){C.data(E);return g};g.rollup=function(){return C.rollup()};g.chart=function(){return C};g.container=function(){return k};g.options=function(){if(arguments.length==0)return b;a=arguments[0];bins=a.bins||bins;w=a.width||w;h=a.height||h;g.update();return g};g.height=function(E){F&&F.height(E);C.height(E-v-x);k.attr("height",E);B.attr("height",
E);return g};g.width=function(E){C.width(E-n);D.width(E-n);k.attr("width",E);B.attr("width",E);return g};g.type=function(){return z||"vis"};g.initUI();return g};dp.bar=function(e,f,b,a){a=a||{};a.chart_type="bar";a.quality_type="bar";return dp.vis(e,f,b,a)};dp.multiples=function(e,f,b,a){spaces_height=72;spaces_width=212;spaces_width_margin=spaces_height_margin=12;var d={},g=a.dims,k=f.data,l,p;p=dv.partition(k,g).views();jQuery("#"+e).addClass("small_multiples_container");d.update=function(){l||
(l=p.map(function(m,s){var n=e+"_multiple"+s,t=dv.jq("div").attr("id",n).addClass("chart_container").addClass("small_multiple");jQuery("#"+e).append(t);m=f.plot("histogram",n,b,{data:m,bins:a.numBins,width:spaces_width-spaces_width_margin,outer_scroll_width:10,height:spaces_height-spaces_height_margin,min:d3.min(k[b[0]]),max:d3.max(k[b[0]])});m.is_small_multiple=true;return{index:s,plot:m}}));l.map(function(m){m.plot.update()});jQuery(".small_multiples_container").jScrollPane().find(".jspHorizontalBar").css("display",
"none");jQuery(".small_multiples_container").find(".jspVerticalBar").css("background-color","#DDD")};d.parent=function(){return jQuery("#"+e)};d.select=function(m){if(m.data){var s;s=dv.partition(m.data,g).views();l.map(function(n,t){n.plot.select({data:s[t],cache:{}})})}else l.map(function(n){n.plot.select({data:undefined,cache:{}})})};d.type=function(){return"multiples"};d.fields=function(){return b};return d};dp.cluster_multiples=function(e,f,b,a){spaces_height=72;spaces_width=212;spaces_width_margin=
spaces_height_margin=12;var d={},g=a.dims,k,l;l=dv.partition(f.data,g).views();jQuery("#"+e).addClass("small_multiples_container");d.parent=function(){return jQuery("#"+e)};d.height=function(){};d.update=function(){if(!k){l.sort(function(p,m){p=f.data[g[0]].lut[p.dims()[0]];m=f.data[g[0]].lut[m.dims()[0]];if(p=="_2001")return-1;if(m=="_2001")return 1;if(p=="_2004")return-1;if(m=="_2004")return 1;if(p=="_2008")return-1;if(m=="_2008")return 1;if(p=="_2009")return-1;if(m=="_2009")return 1;if(p=="_2003")return-1;
if(m=="_2003")return 1;return p<m});k=l.map(function(p,m){var s=p.materialize(),n=dp.qgram_self_cluster(s,b[0],2,3);n=n.filter(function(u){return u.id.replace("The","").length>6});if(n.length){console.log(n);console.log(n.length);n=e+"_multiple"+m;var t=dv.jq("div").attr("id",n).addClass("chart_container").addClass("small_multiple");jQuery("#"+e).append(t);p=f.plot("grouped_bar",n,b,{multiples_offset:10,title_extra:f.data[g[0]].lut[p.dims()[0]],data:s,width:spaces_width-spaces_width_margin,outer_scroll_width:10,
height:(m===2?1.2:m===4?0.2:0.9)*spaces_height-spaces_height_margin});p.is_small_multiple=true;return{index:m,plot:p}}});k=k.filter(function(p){return p!=undefined})}k.map(function(p){p.plot.update()});jQuery(".small_multiples_container").jScrollPane().find(".jspHorizontalBar").css("display","none");jQuery(".small_multiples_container").jScrollPane().find(".jspVerticalBar").css("background-color","#DDD")};d.select=function(p){if(p.data){var m;m=dv.partition(p.data,g).views();k.map(function(s,n){s.plot.select({data:m[n],
cache:{}})})}else k.map(function(s){s.plot.select({data:undefined,cache:{}})})};d.type=function(){return"multiples"};d.fields=function(){return b};return d};dp.grouped_bar=function(e,f,b,a){a=a||{};a.chart_type="grouped_bar";a.quality_type="bar";return dp.vis(e,f,b,a)};dp.histogram=function(e,f,b,a){a=a||{};a.chart_type="histogram";a.quality_type="bar";a.query=dp.query.bin;return dp.vis(e,f,b,a)};dp.date_histogram=function(e,f,b,a){a=a||{};a.chart_type="date_histogram";a.quality_type="bar";var d=
dp.factory.date().default_type(f.data[b[0]]);a.query=dp.factory.date().query(d);a.tick_format=dp.factory.date().ticks(d);return dp.vis(e,f,b,a)};dp.spreadsheet=function(e,f,b,a){a=a||{};a.chart_type="spreadsheet";a.quality_type="spreadsheet";a.container_dom_type="div";a.child_dom_type="div";a.height=300;a.query=undefined;return dp.vis(e,f,b,a)};dp.scatter=function(e,f,b,a){a=a||{};a.chart_type="scatter";a.quality_type="scatter";a.query=dp.query.bin;return dp.vis(e,f,b,a)};dp.month_histogram=function(e,
f,b,a){a=a||{};a.chart_type="month_histogram";a.quality_type="bar";a.query=dp.query.bin;return dp.vis(e,f,b,a)};dp.line=function(e,f,b,a){a=a||{};a.chart_type="line";a.quality_type="bar";var d=dp.factory.date().default_type(f.data[b[0]]);a.query=dp.factory.date().query(d);a.tick_format=dp.factory.date().ticks(d);return dp.vis(e,f,b,a)};dp.schema=function(e,f,b){b=b||{};var a={},d,g=f.data;a.initUI=function(){d3.select("#"+e+" div").remove();d=d3.select("#"+e).append("div").attr("id","schema")};a.data=
function(k){g=k;return a};a.update=function(){function k(){}function l(){}function p(z){f.add_vis(z);b.on_add&&b.on_add()}var m,s,n,t,u,v,A,x;jQuery(d[0]).empty();m=d3.range(g.length);m.filter(function(z){return g[z].type==="nominal"}).concat(m.filter(function(z){return g[z].type==="numeric"}));m=d.selectAll("div.data_label").data(m).enter().append("div").attr("class","data_label").classed("system_col",function(z){return g[z].system}).attr("id",function(z){return"data_label"+z}).on("mouseover",k).on("mouseout",
l).on("dblclick",p);m.append("div").attr("class",function(z){return"type_icon "+g[z].type.type()});m.append("div").attr("class","data_name").text(function(z){return g[z].name()});m.append("div").attr("class","data_menu");m=d.selectAll("div.data_menu");m.append("div").attr("class","data_menu_text").text("options");m.append("div").attr("class","data_menu_icon right");d.selectAll("div.data_label").append("div").attr("class","chart_menu").attr("id",function(z){return"chart_data_menu"+z}).style("width",
100).style("height",80).style("left",160).style("top",function(z){return z*24+25}).style("position","absolute").style("display","none");m={};m.name="Rename";m.type="input";m.options={};s=$(".data_label").size();v=function(z){x=this;if(typeOf(z)=="number")x=$("#data_label"+z+" .data_menu")[0];jQuery(".data_menu_icon",x).toggleClass("right");jQuery(".data_menu_icon",x).toggleClass("down");jQuery(".chart_menu",x.parentElement).toggle();u=!u};for(t=0;t<s;t++){m.options.onenter=function(z,y){A=parseInt(y.substring(6));
v(A);a.change_name(A,z)};m.options.default_value=g[t].name();m.options.editor_id="rename"+t;n=[m];n.map(function(z){dp.menu.menu_widget(jQuery("#chart_data_menu"+t),z.name,z.type,z.options)})}u=false;jQuery("div.data_label").mouseenter(function(){});jQuery("div.data_label").mouseleave(function(){});jQuery("div.data_menu").click(v)};a.change_name=function(k,l){alert(k+": "+l)};a.initUI();a.update();return a};dp.world_map=function(e,f,b,a){a=a||{};a.chart_type="world_map";a.quality_type="bar";return dp.vis(e,
f,b,a)};dp.view=function(e){function f(l,p,m){m=m||{};m=m.suggestion_type||dw.view.related_view_type;d.clear();if(p){m=m==="anomalies"?p.reason().slice(0,10):m==="data values"?p.related().slice(0,10):[];l.table();var s=[];s[p.col]=1;m=m.filter(function(n){if(!n||!n.col)return false;n=n.col;if(n[3]==="(")n=n.substring(4,n.length-1);if(s[n])return false;s[n]=1;return true});d.add_vis(p.col,undefined,undefined,{vis_type:p.vis_type,query:p.binner()});m.slice(0,6).map(function(n){d.add_vis(n.col,undefined,
undefined,{query:n.binner})});p.bin&&p.bin()}}var b={},a=e.suggestion_container,d=e.db,g,k=e.onsuggest;b.initUI=function(){draw_related_options();a.empty()};b.update=function(l){function p(n){l.selected_suggestion_index(n);s();event.preventDefault()}function m(n){var t=l.selected_suggestion_index(),u=undefined;if(t!=undefined)u=l.suggestions()[t];f(l,u,{suggestion_type:n.toLowerCase()})}jQuery("#suggested_view_selector").unbind("onselect").bind("onselect",function(n,t){m(t)});a.append(dv.jq("div"));
g=dw.view.grouped_suggestions(a,{type:dp.view.suggestion.text,onswitchtype:m,onclick:p});g.suggestions(l.suggestions());g.initUI();g.update();var s=function(){var n=l.selected_suggestion_index(),t=undefined;if(n!=undefined)t=l.suggestions()[n];g.highlight_suggestion(n);f(l,t);k&&k(t)};s();jQuery(document).unbind("keydown.profiler_view");jQuery(document).bind("keydown.profiler_view",function(n){if((n&&n.srcElement&&n.srcElement.type)!="text")switch(n.which){case 38:l.decrement_selected_suggestion_index();
s();n.preventDefault();break;case 40:l.increment_selected_suggestion_index();s();n.preventDefault();break;case 27:l.selected_suggestion_index(undefined);s();n.preventDefault();break}})};return b};dp.controller=function(e){e=e||{};var f={},b=e.data,a;f.suggestions=function(){return suggestions};f.selected_suggestion_index=function(d){if(!arguments.length)return a;a=d;return f};f.increment_selected_suggestion_index=function(){if(!suggestions.length)return f;if(a===undefined)a=0;else if(a===suggestions.length-
1)a=0;else a+=1;return f};f.decrement_selected_suggestion_index=function(){if(!suggestions.length)return f;if(a===undefined)a=suggestions.length-1;else if(a===0)a=undefined;else a-=1;return f};f.table=function(){return b};f.interaction=function(){var d;suggestions=[];suggestions=suggestions.concat(dp.suggestion.missing(b));suggestions=suggestions.concat(dp.suggestion.error(b));suggestions=suggestions.concat(dp.suggestion.extreme(b));suggestions=suggestions.concat(dp.suggestion.duplicate(b));suggestions.map(function(g){binner=
function(){return dp.suggestion.entropy.bin(b,b[g.col],g.bin()).binner};g.binner=binner;d=function(){if(!g.bin)return[];return dp.suggestion.entropy(b,dp.factory.bin().default_bin(b,b[g.col]),{ignored_columns:[g.col]})};g.related=d;reason=function(){if(!g.bin)return[];return dp.suggestion.entropy(b,g.bin(),{ignored_columns:[g.col]})};g.reason=reason});a=undefined;return f};return f};dp.text_cluster=function(e,f,b,a){a=a||{};a.chart_type="text_cluster";a.quality_type="spreadsheet";a.container_dom_type=
"div";a.child_dom_type="div";a.height=300;return dp.vis(e,f,b,a)};dp.query={};dp.query.bin=function(e,f,b){b=b||{};b.min=b.min||[];b.max=b.max||[];b.step=b.step||[];var a=b.bins||10,d=[],g=[],k=[],l=[],p=[],m;f.map(function(s,n){m=R(e[s],a,b.min[n],b.max[n],b.step[n]);g.push(m[0]);k.push(m[1]);l.push(m[2]);p.push(Math.ceil((k[n]-g[n])/l[n]));d.push(dv.bin(s,l[n],g[n],k[n]))});return{dims:d,vals:[dv.count("*")],parameters:{num_bins:p,step:l,min:g,max:k},code:true}};dp.query.group=function(e,f){return{dims:[f[0]],
vals:[dv.count("*")],code:false}};dp.query.quarter=function(e,f,b){b=b||{};var a=[],d=[];f.map(function(g){d.push(4);a.push(dv.quarter(g))});return{dims:a,vals:[dv.count("*")],parameters:{num_bins:d},code:true}};dp.query.month=function(e,f,b){b=b||{};var a=[],d=[];f.map(function(g){d.push(12);a.push(dv.month(g))});return{dims:a,vals:[dv.count("*")],parameters:{num_bins:d},code:true}};dp.query.year=function(e,f,b){b=b||{};var a=[],d=[];f.map(function(g){minmax=dt.minmax(e[g]);min=dt.year(minmax[0]);
max=dt.year(minmax[1]);d.push(dt.year_difference(max,min)+1);a.push(dv.year(g,min.getFullYear(),max.getFullYear()))});return{dims:a,vals:[dv.count("*")],parameters:{num_bins:d},code:true}};dp.query.month_year=function(e,f,b){b=b||{};var a=[],d=[],g,k,l;f.map(function(p){g=dt.minmax(e[p]);k=dt.day(g[0]);l=dt.day(g[1]);d.push(dt.month_year_difference(l,k)+1);a.push(dv.month_year(p,k,l))});return{dims:a,vals:[dv.count("*")],parameters:{num_bins:d},code:true}};dp.query.day=function(e,f,b){b=b||{};var a=
[],d=[],g,k,l;f.map(function(p){g=dt.minmax(e[p]);k=dt.day(g[0]);l=dt.day(g[1]);d.push(~~dt.day_difference(l,k)+1);a.push(dv.day(p,k,l))});return{dims:a,vals:[dv.count("*")],parameters:{num_bins:d},code:true}};dp.query.hour=function(e,f,b){b=b||{};var a=[],d=[],g,k,l;f.map(function(p){g=dt.minmax(e[p]);k=dt.hour(g[0]);l=dt.hour(g[1]);d.push(~~dt.hour_difference(l,k)+1);a.push(dv.hour(p,k,l))});return{dims:a,vals:[dv.count("*")],parameters:{num_bins:d},code:true}};dp.chart={};dp.chart.chart=function(e,
f,b,a){var d={},g,k=a.data||f.data,l,p=a.width||200,m=a.height||194,s,n,t,u,v,A;if(typeOf(e)==="string")e=d3.select("#"+e).append("svg:svg").attr("width",p).attr("height",m);d.initBins=function(){};d.initUI=function(){jQuery(e[0]).empty();e.attr("class","chart_area");g=e.append("svg:g").attr("width",p).attr("height",m).attr("class","bordered")};d.container=function(x){if(!arguments.length)return e;e=x;return d};d.vis=function(x){if(!arguments.length)return g;g=x;return d};d.width=function(x){if(!arguments.length)return p;
p=x;return d};d.height=function(x){if(!arguments.length)return m;m=x;return d};d.update=function(){d.initBins();d.draw()};d.option=function(x,z){if(arguments.length===1)return a[x];a[x]=z;return d};d.data=function(x){if(!arguments.length)return k;k=x;return d};d.group=function(){return f};d.update_rollup=function(){l=u?k.query(u):k;return d};d.rollup=function(x){if(!arguments.length)return l;l=x;return d};d.query=function(x){if(!arguments.length)return u;u=x;return d};d.marks=function(x){if(!arguments.length)return n;
n=x;return d};d.start_row=function(x){if(!arguments.length)return v;v=x;return d};d.end_row=function(x){if(!arguments.length)return A;A=x;return d};d.targets=function(x){if(!arguments.length)return s;s=x;return d};d.selection=function(x){if(!arguments.length)return t;var z=d.group().selection_manager();t&&z.remove(t);t=x;z.add(t);return d};d.fields=function(x){if(!arguments.length)return b;b=x;return d};return d};dp.chart.bar=function(e,f,b){var a=this,d=dp.config.vis,g=dp.chart.chart(e,a,f,b),k=
f[0],l=b.bar_spacing||dp.config.vis.bar_spacing||2,p=b.bar_height||dp.config.vis.bar_height||10,m=60,s,n;g.width(b.width||180);g.height(b.height||594);g.selection(dp.selection(a,g,f));g.start_row(b.start_row||0);g.end_row(b.end_row||g.start_row()+60);g.initBins=function(){var t={dims:[k],vals:[dv.count("*")],code:false};g.query(t)};g.draw=function(){var t=g.rollup(),u=g.width();g.height();var v,A,x,z=g.data(),y=g.vis();v=b.sort||"count";y.selectAll("text").remove();y.selectAll("rect").remove();t=
dv.partition_results(t,f,f.length,{missing:t[0][t[0].length-2],error:t[0][t[0].length-1]}).clean;if(t[0].length===2)p=30;n=d3.range(t[0].length);if(v==="count"){t=dv.sort_multiple(t,[f.length],[dv.result_order.DESC]);n=t.idx}m=Math.min(60,t[0].length);v=d3.range(g.start_row()||0,Math.min(g.end_row()||t[0].length,t[0].length));s=d3.scale.linear().domain([0,d3.max(t[1])]).range([0,u-0]);A=y.selectAll("rect.base").data(v).enter().append("svg:rect").attr("class","base").attr("y",function(B,C){return(p+
l)*C}).attr("x",0).attr("height",p).attr("width",function(B){B=t[1][B];if(B===0)return 0;B=s(B);return Math.max(B,2)});x=y.selectAll("rect.pointer").data(v).enter().append("svg:rect").attr("class","pointer");y.selectAll("rect.pointer").attr("y",function(B,C){return(p+l)*C}).attr("x",0).attr("width",u).attr("height",p).attr("opacity",0);y.selectAll("rect.brush").data(v).enter().append("svg:rect").attr("class","brush");y.selectAll("rect.brush").attr("y",function(B,C){return(p+l)*C}).attr("x",0).attr("height",
p).attr("width",0);y.selectAll("text.bar_label").data(v).enter().append("svg:text").attr("y",function(B,C){return(p+l)*C}).attr("x",0).attr("class","bar_label").attr("text-anchor","left").attr("dy",d.bar_label_y).attr("dx",d.bar_label_x).attr("pointer-events","none").text(function(B){if((B=z[k].lut[t[0][B]])&&B.length>25)B=B.substring(0,22)+"...";return B});g.selection().marks(A).targets(x).rollup(t,v)};g.select=function(t){var u=g.vis();if(t.data){var v=t.data.query(g.query());v=dv.partition_results(v,
f,f.length,{missing:v[0][v[0].length-2],error:v[0][v[0].length-1]}).clean;u.selectAll("rect.brush").attr("width",function(A){A=s(v[1][n[A]]);if(A===0)return 0;return A<=2?2:A})}else u.selectAll("rect.brush").attr("width",0)};g.chart_vis=function(){return vis};g.type=function(){return"bar"};g.initUI();g.initBins();g.update_rollup();return g};dp.chart.grouped_bar=function(e,f,b){var a=this,d=dp.chart.chart(e,a,f,b),g=2,k=10,l=5,p=60,m,s;d.width(b.width||180);d.height(b.height||594);d.selection(dp.selection(a,
d,f));d.start_row(b.start_row||0);d.end_row(b.end_row||d.start_row()+60);d.initBins=function(){d.query(undefined)};d.draw=function(){function n(y,B){return(k+g)*(B-u[0])+l*roll[2][y]}var t=d.width();d.height();var u,v,A;v=d.data();var x=d.vis();A=b.sort||"count";x.selectAll("text").remove();x.selectAll("rect").remove();cached_clusters=dp.qgram_self_cluster(v,f[0],2,3);cached_clusters=cached_clusters.filter(function(y){return["The Alamo","Spy Hard","Die Hard","The Howling","The Calling","Twilight",
"Daylight"].indexOf(y.id)==-1&&y.id.replace("The","").length>6});roll=[[],[],[],[],[],[]];cached_clusters.map(function(y,B){var C=dp.stat.normalized_entropy(y.counts),D=y.counts.reduce(function(H,J){return H+J}),F=y.cluster.filter(function(H){return H[H.length-1]==2}).length>0;y.cluster.map(function(H,J){roll[0].push(H);roll[1].push(y.counts[J]);roll[2].push(B);roll[3].push(C);roll[4].push(F);roll[5].push(D)})});console.log(cached_clusters.length);s=d3.range(roll[0].length);if(A==="count"){roll=dv.sort_multiple(roll,
[4,3,5,2,1,0],[dv.result_order.DESC,dv.result_order.ASC,dv.result_order.DESC,dv.result_order.ASC,dv.result_order.DESC,dv.result_order.ASC]);s=roll.idx;A=v=-1;for(var z=0;z<roll[2].length;++z){if(A!=roll[2][z]){v++;A=roll[2][z]}roll[2][z]=v}}p=Math.min(60,roll[0].length);u=d3.range(d.start_row()||0,Math.min(d.end_row()||roll[0].length,roll[0].length));m=d3.scale.linear().domain([0,d3.max(roll[1])]).range([0,t]);v=x.selectAll("rect.base").data(u).enter().append("svg:rect").attr("class","base").attr("y",
function(y,B){return n(y,B)}).attr("x",0).attr("height",k).attr("width",function(y){y=roll[1][y];if(y===0)return 0;y=m(y);return Math.max(y,2)});A=x.selectAll("rect.pointer").data(u).enter().append("svg:rect").attr("class","pointer");x.selectAll("rect.pointer").attr("y",function(y,B){return n(y,B)}).attr("x",0).attr("width",t).attr("height",k).attr("opacity",0);x.selectAll("rect.brush").data(u).enter().append("svg:rect").attr("class","brush");x.selectAll("rect.brush").attr("y",function(y,B){return n(y,
B)}).attr("x",0).attr("height",k).attr("width",0);x.selectAll("text.label").data(u).enter().append("svg:text").attr("y",function(y,B){return n(y,B)}).attr("x",0).attr("text-anchor","left").attr("class","bar_label").attr("dy","1em").attr("dx",".5em").attr("pointer-events","none").text(function(y){y=roll[0][y];if(y.length>28)y=y.substring(0,25)+"...";return y});d.selection().marks(v).targets(A).rollup(roll,u)};d.select=function(n){var t=d.vis();if(n.data){var u=n.data.query(d.query());u=dv.partition_results(u,
f,f.length,{missing:u[0][u[0].length-2],error:u[0][u[0].length-1]}).clean;t.selectAll("rect.brush").attr("width",function(v){v=m(u[1][s[v]]);if(v===0)return 0;return v<=2?2:v})}else t.selectAll("rect.brush").attr("width",0)};d.chart_vis=function(){return vis};d.type=function(){return"bar"};d.initUI();d.initBins();d.update_rollup();return d};dp.chart.spreadsheet=function(e,f,b){function a(t,u){var v;t.selectAll("th.base").on("click",function(A,x){v=g.data();var z=d3.event;p({type:dw.engine.col,position:{row:A,
col:v[x].name()},table:v,shift:z.shiftKey,ctrl:z.metaKey})});u.selectAll("td.row_header").on("click",function(A){var x=d3.event;v=g.data();p({type:dw.engine.row,position:{row:A,col:-1},table:v,shift:x.shiftKey,ctrl:x.metaKey})});u.selectAll("td:not(.row_header)").on("mouseup",function(A,x){v=g.data();var z=d(),y=""+v[x].get_raw([A]);if(z&&y&&y.length>z.startCursor){var B={row:A,col:v[x].name()},C=z.startCursor===z.endCursor?C:0;setTimeout(function(){n||z.startCursor!=z.endCursor&&p({type:dw.engine.highlight,
position:B,selection:z})},C)}}).on("mousedown",function(){Highlight.removeHighlight(d3.event.currentTarget)})}function d(){var t=window.getSelection();if(t)try{var u=t.getRangeAt(0);return{startCursor:u.startOffset,endCursor:u.endOffset}}catch(v){}}b=b||{};var g=dp.chart.chart(e,b.group||this,f,b),k=b.width||400,l=b.height||194,p=b.interaction,m=b.table_layout||dp.layout.table.uniform(),s=b.limit||15,n=false;g.width(k);g.height(l);g.initUI=function(){jQuery(e[0]).empty();e.attr("class","chart_area");
var t=e.append("table").attr("width",g.width()).attr("height",g.height()).attr("class","bordered");g.vis(t)};g.initBins=function(){g.query(undefined)};g.fields=function(){var t=g.data();if(f&&f.length>0)return f;return d3.range(t.length)};g.field_names=function(){var t=g.data();return g.fields().map(function(u){return t[u].name()})};g.draw=function(){var t=g.rollup(),u=g.fields(),v,A,x,z=g.vis();if(!(!u||u.length===0)){jQuery(z[0]).empty();x=u.map(function(C){v=t[C];return dv.range(s).map(function(D){return v.get_raw(D)})});
A=g.field_names();var y=d3.range(s),B;B=d3.range(x.length).map(function(C){return m.column_width(t,t[C],C,{})});u=20+B.reduce(function(C,D){return C+D},0);z.attr("width",u).attr("min-width",u).attr("max-width",u);u=z.append("thead").attr("class","base").append("tr").attr("class","base header");u.append("th").attr("width",20).attr("min-width",20).attr("max-width",20);u.selectAll("th.base").data(d3.range(x.length)).enter().append("th").attr("class","base").attr("width",function(C){return B[C]}).attr("min-width",
function(C){return B[C]}).attr("max-width",function(C){return B[C]}).text(function(C){return A[C]});z=z.append("tbody").attr("class","base").selectAll("tr.base").data(y).enter().append("tr").attr("class","base");z.append("td").text(function(C,D){return D<t[0].length?D+1:""}).classed("row_header",true);z.selectAll("td.base").data(function(C){return x.map(function(){return C})}).enter().append("td").attr("class","base").text(function(C,D){return x[D][C]!=undefined?(""+x[D][C]).substr(0,15):""});a(u,
z)}};g.select=function(t){var u=g.fields(),v=g.vis();if(t.data){roll=u.map(function(A){var x=t.data[A];return dv.range(s).map(function(z){return x.get_raw(z)})});u=d3.range(s);v.selectAll("tr.base").selectAll("td.base").text(function(A,x){return roll[x][A]!=undefined?roll[x][A]:""})}else{roll=u.map(function(A){var x=data[A];return dv.range(s).map(function(z){return x.get(z)})});u=d3.range(s);v.selectAll("tr.base").selectAll("td.base").text(function(A,x){return roll[x][A]!=undefined?roll[x][A]:""})}};
g.cells=function(t){var u=g.vis();g.data();var v=t.rows,A=t.cols,x=g.field_names(),z;z=u.select("tbody").selectAll("tr");if(v){z=z.filter(function(y,B){return v.indexOf(B)>-1});if(t.header)z=d3.selectAll(d3.merge(d3.merge([u.select("thead").selectAll("tr"),z])))}if(A){z=d3.merge([z.selectAll("th"),z.selectAll("td")]);A=A.map(function(y){return x.indexOf(y.name())+1});z=z.map(function(y){return y.filter(function(B,C){return A.indexOf(C)>-1})});z=d3.selectAll(d3.merge(z))}return z};g.type=function(){return"spreadsheet"};
g.initUI();g.initBins();g.update_rollup();g.visible_rows=function(){return[0,20]};return g};dp.chart.histogram=function(e,f,b){function a(y,B,C){y=C[1][B];B=l.chart_height();if(y===0)return B;return y=u(y)}function d(y,B,C){y=C[1][B];B=l.chart_height();if(y===0)return 0;y=u(y);return B-y}var g=this,k=dp.config.vis,l=dp.chart.chart(e,g,f,b),p=f[0],m=b.bins||20,s=b.label_height||k.xaxis_gutter_height||12,n=[],t,u,v;l.selection((b.selection||dp.selection.range)(g,l,f));l.width(b.width||200);l.height(b.height||
194);l.initBins=function(){var y,B=f;y=l.data();if(b.transform){B=b.transform(dw.derive.variable(p));var C="*"+B.name+"_"+p,D=y[C];D||(D=B.evaluate(y));D=y.addColumn(C,D,D.type,{system:true,encoded:D.lut!=undefined,lut:D.lut});B=[D.name()];l.selection().fields([D.name()])}y=l.query()?l.query():b.query?b.query(y,B,b):dp.query.bin(y,B,{min:b.min,max:b.max,bins:b.bins,step:b.step});l.query(y);if(y.parameters){m=y.parameters.num_bins[0]||m;l.selection().query_parameters(y.parameters)}};l.chart_height=
function(){return l.height()-s};l.draw=function(){var y=(l.update_rollup(),l.rollup()),B=l.width(),C=l.chart_height(),D=Math.floor(B/m),F=l.vis(),H,J;F.selectAll("text").remove();F.selectAll("rect").remove();y=dv.partition_results(y,f,n.length+1).clean;H=d3.range(y[0].length);v=d3.scale.linear().domain([d3.min(y[0]),d3.max(y[0])+(y[0][1]-y[0][0])]).range([0,B]);t=d3.scale.linear().domain([0,H.length]).range([0,B]);y_scale_ticks=d3.scale.linear().domain([0,d3.max(y[1])]).range([C,5]);u=d3.scale.linear().domain([1,
d3.max(y[1])]).range([C-5,0]);B=F.selectAll("rect.base").data(H).enter().append("svg:rect").attr("class","base");F.selectAll("rect.base").attr("x",t).attr("y",function(E,G){return a(E,G,y)}).attr("width",D-1).attr("height",function(E,G){return d(E,G,y)});J=F.selectAll("rect.pointer").data(H).enter().append("svg:rect").attr("class","pointer");F.selectAll("rect.pointer").attr("x",t).attr("y",0).attr("width",D-1).attr("height",C).attr("opacity",0);F.selectAll("rect.brush").data(H).enter().append("svg:rect").attr("class",
"brush");F.selectAll("rect.brush").attr("x",t).attr("y",C).attr("width",D-1).attr("height",0);l.labels();l.selection().marks(B).targets(J).rollup(y)};var A=1E9,x=1E6,z=1E3;l.labels=function(){function y(G){if(G>=A)G=Math.ceil(G/A)+"B";else if(G>=x)G=Math.ceil(G/x)+"M";else if(G>=z)G=Math.ceil(G/z)+"K";return G}var B=v.ticks(10),C=y_scale_ticks.ticks(10),D=l.vis(),F=B[0],H=B[B.length-1];F=dp.tick.pretify(F);H=dp.tick.pretify(H);var J=(H+"").length;B=l.width();var E=l.chart_height();D.selectAll("text.label").data([0]).enter().append("svg:text").attr("x",
1).attr("y",E+k.xaxis_vertical_padding).text(F+"");D.selectAll("text.label").data([0]).enter().append("svg:text").attr("x",B-J*k.axis_character_offset).attr("y",E+k.xaxis_vertical_padding).text(H+"");F=C[0];C=C[C.length-1];F=y(F);C=y(C);H=(F+"").length;J=(C+"").length;D.selectAll("text.label").data([0]).enter().append("svg:text").attr("x",B+k.yaxis_gutter_width-k.yaxis_horizontal_padding-H*k.axis_character_offset).attr("y",E).text(F+"");D.selectAll("text.label").data([0]).enter().append("svg:text").attr("x",
B+k.yaxis_gutter_width-k.yaxis_horizontal_padding-J*k.axis_character_offset).attr("y",s).text(C+"")};l.select=function(y){var B=l.vis(),C=l.height();if(y.data){var D=P(y,l.query());D=dv.partition_results(D,f,n.length+1).clean;B.selectAll("rect.brush").attr("y",function(F,H){return a(F,H,D)}).attr("height",function(F,H){return d(F,H,D)})}else B.selectAll("rect.brush").attr("y",C).attr("height",0)};l.type=function(){return"histogram"};l.initUI();l.initBins();l.update_rollup();return l};dp.chart.date_histogram=
function(e,f,b){var a=this,d=dp.chart.chart(e,a,f,b),g=b.dims||[];e=b.label_height||12;var k,l,p,m;d.width(b.width||200);d.height((b.height||194)-e);d.selection((b.selection||dp.selection.range)(a,d,f));d.initBins=function(){var s;s=d.data();s=b.query?b.query(s,f,b):dp.query.month(s,f,b);d.query(s);s.parameters&&d.selection().query_parameters(s.parameters)};d.draw=function(){var s=d.rollup(),n=d.width(),t=d.height(),u,v=Math.floor(n/s[0].length),A,x=d.vis();x.selectAll("rect").remove();s=dv.partition_results(s,
f,g.length+1).clean;A=d3.range(s[0].length);p=d3.scale.linear().domain([d3.min(s[0]),d3.max(s[0])+(s[0][1]-s[0][0])]).range([0,n]);k=d3.scale.linear().domain([d3.min(s[0]),d3.max(s[0])]).range([0,n-v]);l=d3.scale.linear().domain([0,d3.max(s[1])]).range([0,t]);u=x.selectAll("rect.base").data(A).enter().append("svg:rect").attr("class","base").attr("x",function(z){return k(s[0][z])}).attr("y",function(z){return t-l(s[1][z])}).attr("width",function(){return v-1}).attr("height",function(z){return l(s[1][z])});
n=x.selectAll("rect.pointer").data(A).enter().append("svg:rect").attr("class","pointer").attr("x",function(z){return k(s[0][z])}).attr("y",0).attr("width",v-1).attr("height",t).attr("opacity",0);m=x.selectAll("rect.brush").data(A).enter().append("svg:rect").attr("class","brush").attr("x",function(z){return k(s[0][z])}).attr("y",function(){return 0}).attr("width",function(){return v-1}).attr("height",function(){});d.selection().marks(u).targets(n).rollup(s);d.labels()};d.labels=function(){var s=d.vis();
p.ticks(10);var n=l.ticks(10),t=d.rollup();s.selectAll("text").remove();var u=d3.min(t[0]);t=d3.max(t[0]);u=b.tick_format(new Date(u),u);t=b.tick_format(new Date(t),t%12);var v=(t+"").length;s.selectAll("text.label").data([0]).enter().append("svg:text").attr("x",1).attr("y",192).text(u+"");s.selectAll("text.label").data([0]).enter().append("svg:text").attr("x",178-v*6).attr("y",192).text(t+"");u=n[0];n=n[n.length-1];t=(u+"").length;v=(n+"").length;s.selectAll("text.label").data([0]).enter().append("svg:text").attr("x",
198-t*6).attr("y",180).text(u+"");s.selectAll("text.label").data([0]).enter().append("svg:text").attr("x",198-v*6).attr("y",10).text(n+"")};d.select=function(s){d.vis();var n=d.height();if(s.data){var t=P(s,d.query());t=dv.partition_results(t,f,g.length+1).clean;m.attr("y",function(u){return n-l(t[1][u])}).attr("height",function(u){return l(t[1][u])})}else m.attr("y",function(){return 0}).attr("height",function(){return 0})};d.type=function(){return"line"};d.initUI();d.initBins();d.update_rollup();
return d};dp.chart.line=function(e,f,b){function a(v){if(v===0)return k.chart_height();return v=s(v)}var d=this,g=dp.config.vis,k=dp.chart.chart(e,d,f,b),l=b.dims||[],p=b.label_height||g.xaxis_gutter_height,m,s,n,t,u;k.width(b.width||200);k.height(b.height||194);k.selection((b.selection||dp.selection.range)(d,k,f));k.chart_height=function(){return k.height()-p};k.initBins=function(){var v;v=k.data();v=k.query()?k.query():b.query?b.query(v,f,b):dp.query.month(v,f,b);k.query(v);v.parameters&&k.selection().query_parameters(v.parameters)};
k.draw=function(){var v=(k.update_rollup(),k.rollup()),A=k.width(),x=k.chart_height(),z,y=k.vis();y.selectAll("path").remove();v=dv.partition_results(v,f,l.length+1).clean;z=d3.range(v[0].length);n=d3.scale.linear().domain([d3.min(v[0]),d3.max(v[0])+(v[0][1]-v[0][0])]).range([0,A]);m=d3.scale.linear().domain([d3.min(v[0]),d3.max(v[0])]).range([0,A]);s=d3.scale.linear().domain([0,d3.max(v[1])]).range([x-1,0]);A=y.attr("class","base").selectAll("path.base").data([z]).enter().append("svg:path").attr("class",
"base").attr("d",d3.svg.area().x(function(B){return m(v[0][B])}).y0(function(){return x}).y1(function(B){return a(v[1][B])}));u=d3.svg.area().x(function(B){return m(v[0][B])}).y0(function(){return x}).y1(function(){return x});t=y.selectAll("path.brush").data([z]).enter().append("svg:path").attr("class","brush").attr("d",u);k.selection().marks(A);k.labels()};k.labels=function(){var v=k.vis();n.ticks(10);var A=s.ticks(10),x=k.rollup(),z=k.chart_height(),y=k.width();v.selectAll("text").remove();var B=
d3.min(x[0]);x=d3.max(x[0]);var C=k.query().type;C=C?dp.tick[C]:b.tick_format;B=C(new Date(B),B);x=C(new Date(x),x%12);C=(x+"").length;v.selectAll("text.label").data([0]).enter().append("svg:text").attr("x",1).attr("y",z+g.xaxis_vertical_padding).text(B+"");v.selectAll("text.label").data([0]).enter().append("svg:text").attr("x",y-C*g.axis_character_offset).attr("y",z+g.xaxis_vertical_padding).text(x+"");B=A[0];A=A[A.length-1];x=(B+"").length;C=(A+"").length;v.selectAll("text.label").data([0]).enter().append("svg:text").attr("x",
y+g.yaxis_gutter_width-g.yaxis_horizontal_padding-x*g.axis_character_offset).attr("y",z).text(B+"");v.selectAll("text.label").data([0]).enter().append("svg:text").attr("x",y+g.yaxis_gutter_width-g.yaxis_horizontal_padding-C*g.axis_character_offset).attr("y",p).text(A+"")};k.select=function(v){k.vis();var A=k.chart_height();if(v.data){var x=P(v,k.query());x=dv.partition_results(x,f,l.length+1).clean;t.attr("d",u.y1(function(z){return a(x[1][z])})).classed("selected",true)}else t.attr("d",u.y1(A)).classed("selected",
false)};k.type=function(){return"line"};k.initUI();k.initBins();k.update_rollup();return k};dp.chart.scatter=function(e,f,b){function a(u,v){u=v[2][u];return u==0?0:t(u)}function d(u){for(var v=[],A=u[2].length,x=0;x<A;++x)u[2][x]>0&&v.push(x);return v}var g=this,k=dp.chart.chart(e,g,f,b),l=20,p=b.dims||[],m,s,n=global_scatter_visible===true?0.2:0,t;k.width(b.width||200);k.height(b.height||200);k.selection(dp.selection.range(g,k,f));k.initBins=function(){b.bins=20;var u;u=f;var v=k.data();if(b.transform){var A=
u[0],x=b.transform(dw.derive.variable(A));A="*"+x.name+"_"+A;var z=v[A];z||(z=x.evaluate(v));z=v.addColumn(A,z,z.type,{system:true,encoded:z.lut!=undefined,lut:z.lut});u=[z.name(),u[1]];k.selection().fields(u)}u=b.query?b.query(v,u,b):dp.query.bin(v,u,b);k.query(u);if(u.parameters){l=u.parameters.num_bins||l;k.selection().query_parameters(u.parameters);k.selection().step(u.parameters.step);k.selection().num_bins(l);m=l[0];s=l[1]}};k.draw=function(){var u=(k.update_rollup(),k.rollup()),v=k.vis(),A=
k.width(),x=k.height(),z=Math.floor(A/m),y=Math.floor(x/s),B,C,D,F,H,J,E;u=dv.partition_results(u,f,p.length+1).clean;B=d3.max(u[0]);C=d3.min(u[0]);F=d3.min(u[1]);D=d3.max(u[1]);H=d3.scale.linear().domain([C,B]).range([0,z*(m-1)]);J=d3.scale.linear().domain([F,D]).range([y*(s-1),0]);t=d3.scale.linear().domain([0,d3.max(u[2])]).range([n,1]);v.selectAll("text").remove();v.selectAll("rect").remove();var G=d(u);E=C=v.selectAll("rect.base").data(G).enter().append("svg:rect").attr("class","base").classed("scatter_base",
"true").attr("x",function(I){return H(u[0][I])}).attr("y",function(I){return J(u[1][I])-1.5}).attr("width",z).attr("height",y).attr("opacity",function(I){return a(I,u)});v.selectAll("rect.brush").data(G).enter().append("svg:rect").attr("class","brush").attr("pointer-events","none").attr("width",z).attr("height",y).attr("x",function(I){return H(u[0][I])}).attr("y",function(I){return J(u[1][I])-1.5}).style("opacity",0);z=u[0][0];B=B+u[0][1]-u[0][0];D=D+u[1][1]-u[1][0];u=u.map(function(I){return G.map(function(K){return I[K]})});
v.append("svg:text").text(dp.tick.pretify(B)).attr("y",x-1).attr("x",A-15);v.append("svg:text").text(z).attr("x",1).attr("y",x-1);v.append("svg:text").text(dp.tick.pretify(D)).attr("y","10").attr("x",A).attr("dx",-3);v.append("svg:text").text(dp.tick.pretify(F)).attr("x",A).attr("dx",-3).attr("y",x-20);k.selection().marks(C).targets(E).rollup(u)};k.select=function(u){var v=k.vis();if(u.data){var A=u.data.query(k.query());partition_results=dv.partition_results(A,f,p.length+1);A=partition_results.clean;
v.selectAll("rect.brush").style("opacity",function(x){return a(x,A)})}else v.selectAll("rect.brush").style("opacity",0)};k.type=function(){return"scatter"};k.initUI();k.initBins();k.update_rollup();return k};dp.chart.world_map=function(e,f,b){function a(y,B,C){y=m[B];if(y===-1)return 0;return C[1][y]}function d(y,B,C){var D=d3.max(C[1]);y=a(y,B,C);if(y===0)return"";return"Blues q"+Math.min(Math.floor(y/D*7*1)+1,8)+"-9"}var g=this,k=dp.config.vis,l=dp.chart.chart(e,g,f,b),p=f[0],m,s=b.ext_container,
n=b.graph_id,t=0.8,u=0,v=0,A=false,x=false,z=false;l.width(b.width||400);l.height(b.height||594);l.selection(dp.selection.world_map(g,l,f));l.initBins=function(){var y={dims:[p],vals:[dv.count("*")],code:false};l.query(y)};l.draw=function(){var y=l.update_rollup().rollup();l.width();l.height();var B=l.vis(),C=d3.geo.mercator();C=d3.geo.path().projection(C);var D=world_countries_features.features,F;F=l.data();d3.max(y[1]);partition_results=dv.partition_results(y,f,f.length);y=partition_results.clean;
field_lut=F[p].lut;m=D.map(function(H){return H.id}).map(function(H){return field_lut.indexOf(H)});s.on("mousedown",function(){A=true});s.on("mouseup",function(){z=x=A=false});$("body").mouseup(function(){z=x=A=false});$("#"+n).mousewheel(function(H,J){t+=J/30;if(t<0.2)t=0.2;if(t>20)t=20;l.zoom(t,u,v)});$("#"+n).mousemove(function(H){if(A){if(x!==false){var J=H.layerY-z;u+=H.layerX-x;v+=J;l.zoom(t,u,v)}x=H.layerX;z=H.layerY}});F=B.append("svg:g").selectAll("path.map_region").data(D).enter().append("svg:path").attr("d",
C).attr("class",function(H,J){return d(H,J,y)}).classed("Blues",true).classed("map_region",true);B.append("svg:g").selectAll("path.brush").data(D).enter().append("svg:path").attr("d",C).attr("class","brush").style("opacity",0).attr("pointer-events","none");u+=k.map_padding_x;v+=k.map_padding_y;l.zoom(t,u,v);l.selection().marks(F).targets(F).rollup([m])};l.zoom=function(y,B,C){B=B||0;C=C||0;B=-180*y/0.8+B;C=-12*y/0.8+C;l.vis().attr("transform","translate("+B+","+C+") scale("+y+")");$("#"+n+" path").css("stroke-width",
0.8/y+"px")};l.select=function(y){var B=l.vis();if(y.data){var C=y.data.query(l.query()),D=d3.scale.linear().domain([0,d3.max(C[1])]).range([0.1,0.9]);partition_results=dv.partition_results(C,f,f.length);C=partition_results.clean;B.selectAll("path.brush").style("opacity",function(F,H){F=a(F,H,C);if(F===0)return 0;return D(F)}).classed("brush",true)}else B.selectAll("path.brush").classed("brush",true).style("opacity",0)};l.type=function(){return"atlas"};l.initUI();l.vis().attr("transform","translate(-180,-12) scale(0.8)");
return l};dp.chart.month_histogram=function(e,f,b){b=b||{};var a=b.group||this,d=["J","F","M","A","M","J","J","A","S","O","N","D"];b.query=dp.query.month;b.selection=dp.selection.month;b.tick_format=function(g){return d[g]};b.tick_text_anchor="center";e=dp.chart.histogram.apply(a,[e,f,b]);e.type=function(){return"month_histogram"};return e};dp.chart.text_cluster=function(e,f,b){b=b||{};var a=dp.chart.chart(e,b.group||this,f,b),d=b.height||194;a.width(b.width||400);a.height(d);a.initUI=function(){jQuery(e[0]).empty();
e.attr("class","chart_area");var g=e.append("div").attr("width",a.width()).attr("min-width",a.width()).attr("height",a.height()).attr("class","bordered").classed("cluster_visualization",true);a.vis(g)};a.initBins=function(){a.query(undefined)};a.draw=function(){var g=a.data(),k=a.fields(),l,p=a.vis();if(!(!k||k.length===0)){jQuery(p[0]).empty();dv.partition(g,["datestr(Release Date)"]);cached_clusters=l=dp.qgram_self_cluster(g,k[0],2,2);g=d3.range(Math.min(l.length,25));p.append("div").attr("class",
"base").selectAll("div.base").data(g).enter().append("div").attr("class","base").classed("cluster_group",true).selectAll("div.cluster_element").data(function(m){return d3.range(l[m].cluster.length).map(function(){return m})}).enter().append("div").attr("class","cluster_element").text(function(m,s){var n=l[m].cluster[s];m=l[m].counts[s];return n!=undefined?(""+n).substr(0,35)+" ("+m+")":""})}};a.select=function(g){var k=a.vis(),l;if(g.data){jQuery(k[0]).empty();var p=[],m=[];g=g.data[f[0]];var s=g.lut;
g.map(function(t){if(t&&!p[s[t]]){m.push(s[t]);p[s[t]]=1}});m.sort();l=dp.qgram_self_cluster(m,2,2);g=d3.range(Math.min(l.length,25));var n=20;groups=k.append("div").attr("class","base").selectAll("div.base").data(g).enter().append("div").attr("class","base").classed("cluster_group",true);groups.selectAll("div.cluster_element").data(function(t){return l[t].cluster}).enter().append("div").attr("class","cluster_element").text(function(t){return t!=undefined?(""+t).substr(0,35):""})}else{jQuery(k[0]).empty();
l=cached_clusters;g=d3.range(Math.min(l.length,25));n=20;groups=k.append("div").attr("class","base").selectAll("div.base").data(g).enter().append("div").attr("class","base").classed("cluster_group",true);groups.selectAll("div.cluster_element").data(function(t){return l[t].cluster}).enter().append("div").attr("class","cluster_element").text(function(t){return t!=undefined?(""+t).substr(0,35):""})}};a.type=function(){return"text_cluster"};a.initUI();a.initBins();a.update_rollup();a.visible_rows=function(){return[0,
20]};return a};dp.factory=function(e){var f={},b=e.cellHeight(),a=e.cellWidth(),d=2*e.verticalMargin(),g=2*e.horizontalMargin();f.default_vis=function(k,l,p,m,s){s=s||{};var n,t,u=k.data;if(p.length===0)if(l.length===1){t=u[l[0]].type.type();switch(t){case "number":case "int":case "numeric":n=k.plot("histogram",m,l,{bins:s.numBins,width:a-g,height:b-d});break;case "datetime":n=k.plot("datetime",m,l,{bins:s.numBins,width:a-g,height:b-d});break;case "geolocation":n=k.plot("histogram",m,l,{bins:s.numBins,
width:a-g,height:b-d});break;case "geo":n=k.plot("bar",m,l,{width:a-g,height:b*3-d});s.num_bars=n.num_bars;break;case "geo_world":n=k.plot("world_map",m,l,{bins:s.numBins,width:a*2-g,height:b*3-d,geotype:"geocountry"});break;case "ordinal":n=k.plot("line",m,l,{width:a-g,height:b*1-d});break;case "string":case "nominal":n=s.vis_type==="text_cluster"?k.plot("text_cluster",m,l,{width:a-g,height:b*3-d}):s.vis_type==="grouped_bar"?k.plot("grouped_bar",m,l,{width:a-g,height:b*3-d}):k.plot("bar",m,l,{width:a-
g,height:b*3-d});s.num_bars=n.num_bars;break}}if(p.length===1&&l.length===1){$("#"+m).children().first().remove();if(u[p[0]].type.type()==="numeric"&&u[l[0]].type.type()==="numeric"){t="scatter";n=k.plot("scatter",m,[p[0][0],l[0]],{width:a-g,height:b*3-d})}else{n=k.plot("multiples",m,p,{bins:s.numBins,width:a-g,height:b-d,dims:l});t="multiples"}}s.query&&n.chart().query(s.query);return{plot:n,type:t,num_bars:s.num_bars}};return f};dp.factory.bin=function(){var e={},f=dp.factory.date();e.default_bin=
function(b,a){switch(a.type.type()){case "number":case "int":case "numeric":return dp.query.bin(b,[a.name()]).dims[0].array(a);case "datetime":case "ordinal":return f.query(f.default_type(a))(b,[a.name()]).dims[0].array(a);case "geo":return a;case "geolocation":return a;case "geo_world":return a;case "string":case "nominal":return dv.categorical_bin(a.name()).array(a,a.lut)}};e.all_bins=function(b,a){var d;switch(a.type.type()){case "number":case "int":case "numeric":d=[10];return d.map(function(k){var l=
dp.query.bin(b,[a.name()],{bins:k});l.bin=function(){return l.dims[0].array(a)};return l});case "datetime":case "ordinal":d=["year","month","quarter"];return d.map(function(k){var l=f.query(k)(b,[a.name()]);l.bin=function(){return l.dims[0].array(a)};l.type=k;return l});case "geolocation":return[{bin:function(){return a}}];case "geo_world":return[{bin:function(){return a}}];case "string":case "nominal":var g=dv.categorical_bin(a.name());g.bin=function(){return g.array(a,a.lut)};return[g]}};return e};
dp.factory.date=function(){var e={};e.default_type=function(f,b){b=b||{};var a=b.min;b=b.max;var d;if(a==undefined){d=dt.minmax(f);a=d[0]}if(b==undefined){d=d||dt.minmax(f);b=d[1]}if(b-a<864E5)return"hour";return"year"};e.query=function(f){return dp.query[f]};e.ticks=function(f){return dp.tick[f]};return e};dp.quality={valid:"valid",error:"error",missing:"missing"};dp.quality.keys=[dp.quality.valid,dp.quality.error,dp.quality.missing];dp.quality.bar=function(e,f,b){var a=this,d=dp.chart.chart(e,a,
f,b),g=a.data,k,l,p=dp.selection.quality(a,d,f);d.width(b.width||200);d.height(b.height||30);d.selection(p);d.initBins=function(){k=b.query?b.query(g,f,b):{dims:[d.fields()[0]],vals:[dv.count("*")],code:true};d.query(k)};d.draw=function(){var n=d.vis(),t=d.width(),u=d.height(),v=g.query(k);partition_results=dv.partition_results(v,f,1);v=partition_results.summaries[0];sortidx=v.idx;l=m(v,10,t);t=n.selectAll("rect.bar").data(l).enter().append("svg:rect").attr("x",function(A,x){return l.slice(0,x).reduce(function(z,
y){return z+y.val},0)}).attr("class",function(A){return A.type}).classed("bar",true).attr("width",function(A){return A.val}).attr("height",u);t.append("svg:title").text(function(A){return s(v,A)});n.selectAll("rect.bar_brush").data(l).enter().append("svg:rect").attr("class",function(A){return A.type}).classed("bar_brush",true).attr("x",function(A,x){return l.slice(0,x).reduce(function(z,y){return z+y.val},0)}).attr("width",0).attr("height",u);n=n.selectAll("rect.pointer").data(l).enter().append("svg:rect").attr("x",
function(A,x){return l.slice(0,x).reduce(function(z,y){return z+y.val},0)}).attr("opacity",0).attr("class","pointer").attr("width",function(A){return A.val}).attr("height",u);p.marks(t).targets(n).rollup(v);return t};d.select=function(n){var t=t=d.vis();if(n.data){var u=d.width();d.height();n=n.data.query(k);partition_results=dv.partition_results(n,f,1);n=partition_results.summaries[0];sortidx=n.idx;l=m(n,10,u,{total:d.data().rows()});t.selectAll("rect.bar").classed("background",true);t.selectAll("rect.bar_brush").attr("width",
function(v,A){return l[A].val})}else{t.selectAll("rect.bar").classed("background",false);t.selectAll("rect.bar_brush").attr("width",0)}};var m=function(n,t,u,v){v=v||{};var A=[],x,z,y,B=0,C;n.total=x=v.total||n.valid+n.error+n.missing;z=d3.keys(n).filter(function(D){return D!="unique"&&D!="total"}).filter(function(D){return n[D]!=0}).length;y=u-z*t;dp.quality.keys.forEach(function(D){C=Math.round(n[D]===0?0:t+y*(n[D]-1)/(x-z));A.push({type:D,val:C});B+=C});return A},s=function(n,t){n=n[t.type];switch(t.type){case "missing":case "valid":return n+
" "+t.type+" "+(n===1?"value":"values");case "error":return n+" "+(n===1?"value":"values")+" don't parse"}};d.type=function(){return"bar"};d.initUI();return d};dp.quality.scatter=function(e,f,b){var a={},d=this.data,g=f[0],k=b.width||400,l=b.height||30,p;if(typeOf(e)==="string")e=d3.select("#"+e).append("svg:svg").attr("width",k).attr("height",l);a.initUI=function(){e.attr("class","chart_area");p=e.append("svg:g").attr("width",k).attr("height",l).attr("class","bordered")};a.initBins=function(){b.query?
b.query(d,f,b):dv.count("*")};a.update=function(){p.append("svg:rect").attr("width",k).attr("height",l).classed("valid",true)};a.select=function(){};a.rollup=function(){return roll};a.fields=function(){if(arguments.length==0)return f;f=arguments;g=f[0];return a};a.options=function(){if(arguments.length==0)return f;b=arguments[0];bins=b.bins||bins;w=b.width||w;h=b.height||h;a.update();return a};a.type=function(){return"scatter"};a.initUI();a.update();return a};dp.quality.spreadsheet=function(e,f,b){e=
dp.chart.chart(e,this,f,b);e.width(b.width||200);e.height(b.height||30);e.initBins=function(){};e.draw=function(){};e.select=function(){};e.type=function(){return"spreadsheet"};e.initUI();return e};dp.tick={};dp.tick.pretify=function(e){if(e>=1E9)e=Math.ceil(e/1E9)+"B";else if(e>=1E6)e=Math.ceil(e/1E6)+"M";else if(e>=1E3)e=Math.ceil(e/1E3)+"K";return e};dp.tick.month=function(){var e=["Jan","Feb","Mar","Apr","Mar","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];return function(f,b){return e[b]}}();dp.tick.quarter=
function(){var e=["Q1","Q2","Q3","Q4"];return function(f,b){return e[b]}}();dp.tick.month_year=function(){return function(e){return[e.getMonth()+1,e.getFullYear()].join("/")}}();dp.tick.year=function(){return function(e,f){if(f===0)return 1911;return 2010}}();dp.tick.day=function(){return function(e){return[e.getMonth()+1,e.getDate(),e.getFullYear()].join("-")}}();dp.tick.hour=function(){return function(e){e=e.getHours();var f="AM";if(e>12){f="PM";e-=12}else if(e==0)e=12;else if(e==12)f="PM";return e+
":00 "+f}}();dp.scroll={};dp.scroll.histogram=function(){};dp.scroll.bar=function(e,f,b){var a=this,d=dp.chart.chart(e,a,f,b),g=b.chart_vis,k;dp.selection(a,d,f);var l,p;d.width(b.width||20);d.height(b.height||594);d.initUI=function(){e.attr("class","chart_area");k=e.append("svg:g").attr("width",d.width()).attr("height",d.height()).attr("class","bordered");k.attr("transform","translate(180,10)")};d.initBins=function(){d.query({dims:d.fields(),vals:[dv.count("*")],code:false})};d.draw=function(){var m=
d.update_rollup().rollup();m=dv.partition_results(m,f,1).clean;m=dv.sort_multiple(m,[f.length],[dv.result_order.DESC]);Math.min(60,m[0].length);d3.range(m[0].length);var s=[],n=d.height();for(i=0;i<n;i++)s.push(i);l=k.append("svg:g").attr("width",d.width()).attr("height",d.height()).attr("class","profilerScrollBar");x_scale_scrollbar=d3.scale.linear().domain([0,d3.max(m[1])]).range([0,d.width()]);d.redraw(0,0)};d.contextmouseover=function(m,s,n){if(dp.selection.is_mouse_down||n){g.start_row(m);g.end_row(m+
60);g.update();d.redraw(m,s)}};d.redraw=function(m,s){m=[];var n=d.height()*2,t=true,u=d.update_rollup().rollup();u=dv.partition_results(u,f,1).clean;u=dv.sort_multiple(u,[f.length],[dv.result_order.DESC]);if(d.rollup()[0].length<24)t=false;for(var v=0;v<n;v++)m.push(v);l.selectAll("rect").remove();p=l.append("svg:rect").attr("class","context").attr("y",function(){return 0}).attr("x",0).attr("height",n).attr("width",d.width());if(t){var A=d3.scale.linear().domain([0,d3.max(u[1])]).range([0,d.width()]),
x=d3.scale.linear().domain([0,2*u[1].length]).range([0,n]);l.selectAll("rect.base").data(d.rollup()[1]).enter().append("svg:rect").attr("class","base  ").attr("y",function(z,y){return x(y)}).attr("x",0).attr("height",1).attr("width",function(z,y){return A((y<2&&y%2===0)+1)}).attr("opacity",0.6);p=l.selectAll("rect.context_filled").data(d3.range(s-5,s+19)).enter().append("svg:rect").attr("class","context_filled").attr("y",function(z){return 1*z+5}).attr("x",0).attr("height",1).attr("width",d.width())}t&&
p.on("click",function(z,y){d.contextmouseover(z,y,true)}).on("mouseover",function(z,y){d.contextmouseover(z,y,false)}).on("mousedown",function(z,y){d.contextmouseover(z,y,false)})};d.type=function(){return"bar"};d.initUI();return d};dp.scroll.scatter=function(e,f,b){var a=this,d=dp.chart.chart(e,a,f,b),g=b.chart_vis,k;dp.selection(a,d,f);var l;d.width(b.width||20);d.height(b.height||594);d.initUI=function(){e.attr("class","chart_area");k=e.append("svg:g").attr("width",d.width()).attr("height",d.height()).attr("transform",
"translate(180,10)").attr("class","bordered")};d.initBins=function(){d.query({dims:d.fields(),vals:[dv.count("*")],code:false})};d.draw=function(){k.selectAll("text").remove();k.selectAll("rect").remove();k.append("svg:rect").attr("width",10).attr("x",10).attr("height",d.height()).classed("valid",true)};d.contextmouseover=function(p,m,s){if(dp.selection.is_mouse_down||s){g.start_row(p);g.end_row(p+60);g.update();d.redraw(p,m)}};d.redraw=function(p,m){p=[];var s=d.height(),n=true;if(d.rollup()[0].length<
24)n=false;for(var t=0;t<s;t++)p.push(t);(void 0).selectAll("rect").remove();l=(void 0).selectAll("rect.base").data(p).enter().append("svg:rect").attr("class",function(u){if(n&&m-5<=u&&u<=m+5)return"context_filled";return"context"}).attr("y",function(u){return 1*u}).attr("x",0).attr("height",1).attr("width",d.width());n&&l.on("click",function(u,v){d.contextmouseover(u,v,true)}).on("mouseover",function(u,v){d.contextmouseover(u,v,false)}).on("mousedown",function(u,v){d.contextmouseover(u,v,false)})};
d.type=function(){return"bar"};d.initUI();return d};dp.menu={};dp.menu.menu=function(e,f,b,a){a=a||{};var d=dp.chart.chart(e,this,f,a),g=a.width||20,k=a.height||10,l=a.quality_width||180,p=a.chart_width||200,m=a.graph_id,s,n,t,u;d.initUI=function(){e.attr("class","chart_area");s=e.append("svg:g").attr("width",g).attr("height",k).attr("transform","translate("+l+",0)").attr("class","bordered")};d.draw=function(){$("#"+m+" .menu_toggler").remove();u=s.append("svg:g").attr("width",g).attr("height",k).attr("fill",
"#EFEFEF").attr("class","menu");n=u.append("svg:image").attr("width",g).attr("height",k).attr("fill","#EFEFEF").attr("class","menu_toggler").attr("xlink:href","../../profiler/style/images/downArrow.png").on("mousedown",d.show);t=d3.select("#"+m).append("div").attr("class","chart_menu").attr("id","chart_menu").style("width",p).style("height",p).style("left",p).style("top",0).style("position","absolute").style("visibility","hidden");b.map(function(v){dp.menu.menu_widget(jQuery(t[0]),v.name,v.type,v.options)})};
d.show=function(){t.style("visibility","visible");n.attr("xlink:href","../../profiler/style/images/rightArrow.png");n.on("mousedown",d.hide)};d.chart=function(){return a.chart_vis};d.hide=function(){t.style("visibility","hidden");n.attr("xlink:href","../../profiler/style/images/downArrow.png");n.on("mousedown",d.show)};return d};dp.menu.menu_widget=function(e,f,b,a){function d(m,s,n,t){var u=dv.jq("input");u.attr("id",l);u.val(t.default_value);u.keypress(function(v){v.keyCode===13&&t.onenter(u.val(),
u.attr("id"))});m.append(u)}function g(m,s,n,t){var u=dv.jq("select",t);u.attr("id",l);u.change(function(){t.onchange(u.val())});m.append(u)}function k(m,s,n,t){n=dv.jq("label");n.attr("for",t);n.append(s);m.append(n)}a=a||{};var l=a.editor_id,p=dv.jq("div").addClass("editor_container");e.append(p);k(p,f,b,l,a);switch(b){case dp.menu.menu_widget.type.input:d(p,f,b,a);break;case dp.menu.menu_widget.type.select:g(p,f,b,a);break}};dp.menu.menu_widget.type={input:"input",select:"select"};dp.menu.histogram=
function(e,f,b){function a(k){var l=g.chart();l.option("bins",k);l.update()}function d(k){var l=g.chart();k==="linear"?l.option("transform",undefined):l.option("transform",dw.derive[k]);l.update()}var g=dp.menu.menu(e,f,[{name:"Bins",type:"select",options:{onchange:a,select_options:{"10":10,"20":20,"50":50}}},{name:"Aggregate",type:"select",options:{select_options:{Count:"Count",Average:"Average",Sum:"Sum"}}},{name:"Scale",type:"select",options:{onchange:d,select_options:{linear:"linear",log:"log",
zscore:"zscore",quantile:"quantile"}}}],b);g.initUI();g.update();return g};dp.menu.date_histogram=function(e,f,b){function a(g){var k=d.chart();k.option("query",dp.factory.date().query(g));k.option("tick_format",dp.factory.date().ticks(g));k.update()}var d=dp.menu.menu(e,f,[{name:"Bins",type:"select",options:{onchange:a,select_options:{year:"year",month:"month",day:"day"}}}],b);d.initUI();d.update();return d};dp.menu.spreadsheet=function(e,f,b){e=dp.menu.menu(e,f,[],b);e.initUI();e.update();return e};
dp.menu.text_cluster=function(e,f,b){e=dp.menu.menu(e,f,[],b);e.initUI();e.update();return e};dp.menu.bar=function(e,f,b){function a(g){var k=d.chart();k.option("sort",g);k.update()}var d=dp.menu.menu(e,f,[{name:"Sort",type:"select",options:{onchange:a,select_options:{count:"count",alphabet:"alphabetically"}}}],b);d.initUI();d.update();return d};dp.menu.grouped_bar=function(e,f,b){e=dp.menu.menu(e,f,[],b);e.initUI();e.update();return e};dp.menu.line=function(e,f,b){function a(g){var k=d.chart();k.option("query",
dp.factory.date().query(g));k.option("tick_format",dp.factory.date().ticks(g));k.update()}var d=dp.menu.menu(e,f,[{name:"Bins",type:"select",options:{onchange:a,select_options:{year:"year",month:"month",day:"day"}}}],b);d.initUI();d.update();return d};dp.menu.scatter=function(e,f,b){function a(k){var l=g.chart();l.option("bins",k);l.update()}function d(k){var l=g.chart();k==="linear"?l.option("transform",undefined):l.option("transform",dw.derive[k]);l.update();l.option("containing_vis").update_scroll()}
var g=dp.menu.menu(e,f,[{name:"Bins",type:"select",options:{onchange:a,select_options:{"10":10,"20":20,"50":50}}},{name:"Aggregate",type:"select",options:{select_options:{Count:"Count",Average:"Average",Sum:"Sum"}}},{name:"x Scale",type:"select",options:{onchange:d,select_options:{linear:"linear",log:"log"}}},{name:"y Scale",type:"select",options:{onchange:d,select_options:{linear:"linear",log:"log"}}}],b);g.initUI();g.update();return g};dp.menu.world_map=function(e,f,b){e=dp.menu.menu(e,f,[],b);
e.initUI();e.update();return e};dp.menu.month_histogram=function(e,f,b){e=dp.menu.menu(e,f,[],b);e.initUI();e.update();return e};dp.summary={};dp.summary.numeric=function(e,f,b){var a={},d=f[0],g=b.width||400,k=b.height||30;if(typeOf(e)==="string")e=d3.select("#"+e).append("svg:svg").attr("width",g).attr("height",k);a.initUI=function(){e.attr("class","chart_area");e.append("svg:g").attr("width",g).attr("height",k).attr("class","bordered")};a.initBins=function(){};a.update=function(){a.initBins();
return bars};a.select=function(){};a.rollup=function(){return roll};a.fields=function(){if(arguments.length==0)return f;f=arguments;d=f[0];return a};a.options=function(){if(arguments.length==0)return f;b=arguments[0];bins=b.bins||bins;w=b.width||w;h=b.height||h;a.update();return a};a.type=function(){return"bar"};a.initUI();a.update();return a};dp.editor=function(e,f,b){b=b||{};f={};var a=b.width||200,d=b.height||30;if(typeOf(e)==="string")e=d3.select("#"+e).append("div").attr("width",a).attr("height",
d);f.width=function(){if(!arguments.length)return a};f.height=function(){if(!arguments.length)return d};f.container=function(){if(!arguments.length)return e};return f};dp.editor.range=function(e,f,b){f=dp.editor(e,f,b);e=f.container();e=e.append("div").attr("height",f.height()).attr("width",f.width());jQuery(e).slider({range:true,min:0,max:500,values:[75,300],slide:function(a,d){$("#amount").val("$"+d.values[0]+" - $"+d.values[1])}});return f};dp.editor.input=function(e,f,b){return dp.editor(e,f,
b)};dp.editor.formula=function(e,f){function b(){}function a(){g&&g(d.request())}f=f||{};var d={},g=f.onupdate,k=f.width||400,l=f.height||194,p,m,s,n,t=f.transform_types||dw.transform.types,u,v;d.request=function(){var A=m.attr("value",A);switch(n.val()){case "filter":A=dw.derive.derived_predicate(dw.parser.parse(A));break;case "derive":default:A=dw.derive().formula(A).insert_position(dw.INSERT_END);break}return{derived_transform:A,update_dashboard:true}};d.initUI=function(){m=dv.jq("textArea").attr("id",
"playground_script_input");s=dv.jq("button").attr("id","script_submit").append("execute");p=dv.jq("div").attr("id","playground_script_container");n=dv.jq("select").attr("id","upload_example_select");p.append(n).append(s).append(m);s.click(function(){a()});add_option=function(A,x){dv.add_select_option(n,x,A)};n.change(function(){b()});add_option(undefined,"Transform:");t.forEach(function(A){add_option(A,A)});e.append(p)};d.formula=function(A){if(!arguments.length)return u;u=A;d.update();return d};
d.update=function(){if(u)m.attr("value",u);else v&&m.attr("value",v.as_javascript())};d.select=function(A){if(A){u=A.script_text;v=A.transform}else v=u=undefined;d.update()};d.options=function(){if(arguments.length==0)return{};f=arguments[0];bins=f.bins||bins;k=f.width||k;l=f.height||l;d.update();return d};d.type=function(){return"editor"};d.initUI();d.update();return d};dp.layout={};dp.layout.layout=function(e,f){f=f||{};var b={},a=[],d=[],g=0,k=f.parent_left||0;b.profiler=function(){return e};b.createScatter=
function(l,p){var m,s;m="#"+p;p=parseInt(p.substring(5));s=b.remove(p);l.type="scatter";coord=b.get_vis_coordinates(l,p,s.top,s.left);coord.left=0;coord.left+=k;if(coord)if(coord.redraw){b.refresh();b.redraw()}else{$(m).css("top",coord.top+0+"px");$(m).css("left",coord.left+"px")}else $(m).remove()};b.add=function(l,p,m){var s;g++;s="#graph"+g;if(p||m||p===0)p=b.get_vis_coordinates(l,g,p,m);else{p=b.get_vis_coordinates(l,g);if(p.height_slot===3&&p.left_slot===2)if(p.map_vis===1)p.left=212}p.left+=
k;if(p)if(p.redraw){b.refresh();b.redraw()}else{$(s).css("top",p.top+0+"px");$(s).css("left",p.left+"px");if(p.resize){$(s).height(p.height+2);s=document.getElementById(s.substring(1));s.childNodes[0].setAttribute("height",p.height);l.plot.height(p.height)}}else $(s).remove()};b.remove=function(l){var p;for(p=0;p<d.length;p++)if(d[p].chart_id==l){l=d[p];d.splice(p,1);a.splice(p,1);return l}b.update_spaces()};b.redraw=function(){var l,p,m;for(m=0;m<d.length;m++){l=d[m];p="#graph"+l.chart_id;$(p).css("top",
l.top+0+"px");$(p).css("left",l.left+"px")}};b.plots=function(){return a};b.chart_locations=function(){return d};b.num_graphs=function(){return g};b.init_ui=function(){};return b};dp.layout.naive=function(e,f){function b(E,G,I,K,N){var O=p(E);s(I,G,K,N,E);O.css("top",l(I,G)+"px");O.css("left",k(I,G)+"px");K>0&&E.plot.height(a(K))}function a(E){if(!E)return 0;return g(E,B,D)}function d(E){if(!E)return 0;return g(E,C,F)}function g(E,G,I){if(!E)return 0;return(G+I)*E-I}function k(E,G){E=e.position().left-
20;E=d(G)+E;if(G)top+=F;return E}function l(E){var G=e.position().top;G=a(E)+G;if(E)G+=D;return G}function p(E){return E.plot.parent()}function m(E,G,I){if(arguments.length<3)return J[G][E];else J[G][E]=I}function s(E,G,I,K,N){I=E+I;K=G+K;for(c=G;c<K;c++)for(r=E;r<I;r++)m(r,c,N);return true}function n(E,G,I,K){I=E+I;K=G+K;if(I>z||K>y)return false;for(c=G;c<K;c++)for(r=E;r<I;r++)if(m(r,c))return false;return true}function t(E,G){var I,K;for(K=0;K<y;K++)for(I=0;I<z;I++)if(n(I,K,E,G))return{top:I,left:K}}
function u(E){var G=1,I=1;switch(E.type){case "numeric":case "ordinal":break;case "nominal":E=E.plot.rollup()[0].length-2;G=Math.min(3,Math.ceil(E*H/B));break;case "scatter":G=2;break;case "geo_world":I=2;G=3;break}return{vertical_cells:G,horizontal_cells:I}}function v(){jQuery("#app_container").droppable({drop:function(E,G){E=jQuery(G.helper).data("index");E!=undefined&&f.add(E)}});jQuery("div.data_label").draggable({zIndex:3,helper:function(E){var G,I=C-F,K=B-D;G=jQuery(E.currentTarget).index();
E=jQuery(this).clone().appendTo("body").addClass("dragged").data("index",G);jQuery(".data_menu",E).remove();jQuery(".chart_menu",E).remove();G=data[G].type.type();if(G=="nominal"||G=="ordinal")K=B*3-D;else if(G!="numeric"){K=B*5-D;I=C*2-F}$(".dragged").animate({width:I+"px",height:K+"px"},300);return E},start:function(){jQuery("#app_container").addClass("drag_target")},stop:function(){jQuery("#app_container").removeClass("drag_target")}})}f=f||{};var A={},x=dp.config.vis,z=x.max_rows,y=x.max_cols,
B=x.cell_height,C=x.cell_width,D=x.cell_vertical_margin,F=x.cell_horizontal_margin,H=x.bar_height,J;A.cellHeight=function(){return B};A.cellWidth=function(){return C};A.horizontalMargin=function(){return F};A.verticalMargin=function(){return D};J=d3.range(0,y).map(function(){return dv.array(z)});A.add=function(E){var G=u(E),I=G.vertical_cells;G=G.horizontal_cells;var K=t(I,G);K?b(E,K.left,K.top,I,G):p(E).empty()};A.remove=function(E){var G,I;for(I=0;I<y;I++)for(G=0;G<z;G++)if(E===J[I][G])J[I][G]=
0};v();return A};dp.layout.linear=function(e){e=e||{};var f=[],b=e.table_layout||dp.layout.table.uniform();f.add_vis=function(a){f.push(a)};f.refresh=function(){var a;f.forEach(function(d,g){a=b.column_width(f,d,g,{});d.width(a);d.update();d.container().style("display","inline-block")})};return f};dp.layout.table=function(){};dp.layout.table.uniform=function(e){e=e||{};var f={},b=e.max_table_width||800,a=e.min_column_width||100;f.column_width=function(d,g,k,l){l=l||{};return Math.max(a,b/(l.fields||
d).length)};return f};dp.selection=function(e,f,b){var a={},d,g;b=b;f=f;var k,l=[],p,m,s;a.marks=function(n){if(!arguments.length)return d;d=n;a.update();return a};a.group=function(){return e};a.selection_manager=function(n){if(!arguments.length)return m;m=n;return a};a.index=function(n){if(!arguments.length)return s;s=n;a.update();return a};a.query_parameters=function(n){if(!arguments.length)return p;p=n;return a};a.rollup=function(n,t){if(!arguments.length)return k;k=n;if(t)k=k.map(function(u){return t.map(function(v){return u[v]})});
a.update();return a};a.rollup_indices=function(n){if(!arguments.length)return l;l=n;a.update();return a};a.fields=function(n){if(!arguments.length)return b;b=n;a.update();return a};a.targets=function(n){if(!arguments.length)return g;g=n;a.update();return a};a.update=function(){d&&g&&g.on("mouseover",a.mouseover).on("mousedown",a.mousedown).on("click",a.click).on("mouseout",a.mouseout)};a.mouseover=function(n,t){var u=a.formula();u&&u.length&&d3.select("#formulaView").html(u);a.select_element(n,t,
{dragging:true})};a.mousedown=function(n,t){f.option("containing_vis").select({});d3.event.metaKey||(l=[]);d3.event.stopPropagation();dp.selection.is_mouse_down=1;m.current_selection(a);m.clear();a.select_element(n,t,{mouse_down:true})};a.current_rollup_index=function(){return l[l.length-1]};a.select_element=function(n,t,u){u=u||{};t=s?s[t]:t;n=a.current_rollup_index();var v;if(u.mouse_down||a.is_mouse_down()){if(n)v=n.indexOf(t);if(v>-1)a.remove_from_current_rollup(n,t,v);else if(u.dragging)n&&a.add_to_current_rollup(n,
t);else l.push([t]);a.update_brushing();a.select()}};a.remove_from_current_rollup=function(n,t,u){n.splice(u+1,n.length-(u+1))};a.add_to_current_rollup=function(n,t){n.push(t)};a.update_brushing=function(){d3.selectAll(d[0]).classed("brush_over",false);d3.merge(l).map(function(n){d3.select(d[0][n]).classed("brush_over",true)})};a.select=function(){e.select({source:f,filter:a.filter(l)},25);e.formula_editor().formula(a.formula())};a.click=function(){};a.is_mouse_down=function(){return dp.selection.is_mouse_down};
a.mouseout=function(){};a.clear=function(){l=[];a.update_brushing()};a.filter=function(n){if(!(k===undefined||k[0]===undefined||n[0]===undefined||b===undefined)){var t=k[0][n[0][0]],u=b[0];if(n.length===1)return function(v,A){return v[u][A]===t};else{t=n.map(function(v){return k[0][v[0]]});return function(v,A){return t.indexOf(v[u][A])!=-1}}}};a.formula=function(){var n=b[0];return d3.merge(l).map(function(t){return e.data[n].name()+' = "'+e.data[n].lut[k[0][t]]+'"'}).join(" or ")};a.update();return a};
dp.selection.manager=function(e){var f=[],b;f.current_selection=function(a){if(!arguments.length)return b;b=a;return f};f.add=function(a){f.push(a);a.selection_manager(f)};f.remove=function(a){a=f.indexOf(a);a!=-1&&f.splice(a)};f.clear=function(){e.select({source:null},25);f.map(function(a){a!=b&&a.clear()});b=undefined};return f};dp.selection.range=function(e,f,b){function a(m,s,n){var t=p.rollup(),u=n<s;n=g(s,n);s=n[0];n=n[1];var v,A;p.num_bins();var x,z;m.length=0;v=[k(t,0,s),k(t,0,n,true)];A=
[k(t,1,s),k(t,1,n,true)];d3.range(t[0].length).forEach(function(y){x=t[0][y];z=t[1][y];v[0]<=x&&v[1]>x&&A[0]<=z&&A[1]>z&&m.push(y)});u&&m.reverse();console.log(m)}function d(m){var s=m[0];m=m[m.length-1];return s>m?[m,s]:[s,m]}function g(m,s){return m>s?[s,m]:[m,s]}function k(m,s,n,t){return m[s][n]+(t?p.step()[s]:0)}function l(m,s,n){return n===m[s].length-1}var p=dp.selection(e,f,b);p.step=function(m){if(!arguments.length)return p.query_parameters().step;p.query_parameters().step=m;return p};p.num_bins=
function(m){if(!arguments.length)return p.query_parameters().num_bins;p.query_parameters().num_bins=m;return p};p.filter=function(m){m=d3.merge(m);b=p.fields();if(b.length===1){var s=p.rollup(),n=p.step()[0],t=m[0],u=m[m.length-1],v,A,x,z;if(u===undefined)u=t;if(t>u){m=t;t=u;u=m}v=s[0][t];A=s[0][u]+n;x=u===s[0].length-1;z=p.fields()[0];return function(D,F){D=D[z][F];if(D===null||D===undefined)return false;return D>=v&&D<=A&&(x||D!=A)}}if(b.length===2){s=p.rollup();n=p.step();t=m[0];u=m[m.length-1]||
t;var y=b.map(function(D,F){return s[F][t]}),B=b.map(function(D,F){return s[F][u]+n[F]}),C=b.map(function(D,F){return s[F][u]===s[F][s[F].length-1]});console.log(y);console.log(B);return function(D,F){for(var H,J=0;J<b.length;++J){H=D[b[J]][F];if(H===null||H===undefined)return false;if(!(H>=y[J]&&H<=B[J]&&(C[J]||H!=B[J])))return false}return true}}};if(b.length>1){p.remove_from_current_rollup=function(m,s){a(m,m[0],s)};p.add_to_current_rollup=function(m,s){a(m,m[0],s)}}p.formula=function(){var m=
b[0],s,n,t,u=p.rollup(),v=p.rollup_indices(),A=p.group(),x;return v.map(function(z){t=d(z);s=k(u,0,t[0]);n=k(u,0,t[1],true);x=l(u,0,t[1])?" <= ":" < ";return A.data[m].name()+" >= "+s+" and "+A.data[m].name()+x+n}).join(" or ")};return p};dp.selection.month=function(e,f,b){var a=dp.selection(e,f,b);a.filter=function(d){d=d3.merge(d);if(b.length===1){var g=a.rollup(),k=d[0];d=d[1]||k;var l=g[0][k],p=g[0][d]+1,m=d===g[0].length-1,s=a.fields()[0];return function(n,t){n=n[s][t];if(!n)return false;n=n.getMonth();
return n>=l&&n<=p&&(m||n!=p)}}b.length>1&&console.error("Month selection not yet supported for more than one field.")};return a};dp.selection.quality=function(e,f,b){var a=dp.selection(e,f,b);a.filter=function(d){d=d3.merge(d);if(b.length===1){d=d[0];var g=a.fields()[0],k=dt.ERROR,l=dt.MISSING;if(d===0)return function(p,m){p=p[g][m];return p!==l&&p!==k};else if(d===1)return function(p,m){return p[g][m]===k};else if(d===2)return function(p,m){return p[g][m]===l}}};a.formula=function(){var d=a.rollup_indices(),
g=a.group().data[b[0]].name();return d3.merge(d).map(function(k){switch(k){case 0:return g+" is valid";case 1:return g+" is error";case 2:return g+" is missing"}}).join(" or ")};return a};dp.selection.world_map=function(e,f,b){var a=dp.selection(e,f,b);a.filter=function(d){var g=a.rollup();if(!(g===undefined||g[0]===undefined||d[0]===undefined||b===undefined)){var k=g[0][d[0][0]],l=b[0];if(d.length===1)return function(p,m){return p[l][m]===k};else{k=d.map(function(p){return g[0][p[0]]});return function(p,
m){return k.indexOf(p[l][m])!=-1}}}};return a};dp.stat={};dp.stat.entropy=function(e,f,b){f=[M(e,f,b)];b=[dv.count("*")];e=e.query({dims:f,vals:b});return L(e[1])};dp.stat.perplexity=function(e,f,b){return Math.pow(2,dp.stat.entropy(e,f,b))};dp.stat.mutual=function(e,f,b,a){f=[M(e,f,a),M(e,b,a)];b=[dv.count("*")];e=e.query({dims:f,vals:b,code:false});return Q(e,false)};dp.stat.mutual_binned=function(e,f,b){var a=[dv.count("*")];e=e.query({dims:[f,b],vals:a,code:false});return Q(e,false)};dp.stat.normalized_mutual_binned=
function(e,f,b){if(!e){e=dv.table();e.addColumn("dummy",b.slice(),"nominal",{encoded:true,lut:b[0].lut})}var a=[dv.count("*")];e=e.query({dims:[f,b],vals:a,code:false});return S(e,true)};dp.stat.mutualdist=function(e,f,b,a){f=[M(e,f,a),M(e,b,a)];b=[dv.count("*")];e=e.query({dims:f,vals:b,code:false});return Q(e,true)};dp.stat.normalized_entropy=function(e){var f,b,a=0,d=0;if(e.length<=1)return 1;for(f=0;f<e.length;++f)a+=e[f];if(a==0)return 0;for(f=0;f<e.length;++f){b=e[f]/a;if(b>0)d+=b*Math.log(b)}return-d/
Math.log(e.length)};dp.stat.test_stats_normalized_mutual=function(e,f){f=f||false;var b=e[0],a=e[1];e=e[2];var d=dv.array(b.unique),g=dv.array(a.unique),k,l=0,p,m=e.length,s,n=0;for(k=0;k<m;++k){d[b[k]]+=e[k];g[a[k]]+=e[k];l+=e[k]}p=1/(l*Math.LN2);for(k=0;k<m;++k)if(e[k]!=0){s=l*e[k]/(d[b[k]]*g[a[k]]);n+=e[k]*p*Math.log(s)}if(f){d=L(d);g=L(g);return 1-n/(d>g?d:g)}else return n};dp.levenshtein=function(e,f,b){b=b||e.length+f.length;var a=e.length,d=f.length;if(!(a-d>b)){if(a===0){if(d>b)return;return d}if(d===
0){if(a>b)return;return a}var g=0,k=0,l=[];for(g=0;g<=a;g++){l[g]=[];l[g][0]=g}for(k=0;k<=d;k++)l[0][k]=k;var p,m,s,n,t=Math.max,u=Math.min;for(g=1;g<=a;g++){p=true;for(k=t(1,g-b);k<=u(d,g+b);k++){m=l[g-1][k];s=l[g][k-1];n=l[g-1][k-1];if(m===undefined)m=Infinity;if(s===undefined)s=Infinity;m=u(m+1,s+1,n+(e[g-1]===f[k-1]?0:1));if(m<=b)p=false;l[g][k]=m}if(p)return}return l[a][d]}};dp.atomic_string=function(e,f,b){b=b||dp.atomic_string.delimiter;var a=0,d=0,g,k,l,p=0;e=e.split(b).sort();f=f.split(b).sort();
b=e.length;for(g=f.length;a<b,d<g;){k=e[a];l=f[d];if(k===l){p++;++a;++d}else if(k<l)++a;else++d}return 2*p/(b+g)};dp.atomic_string.delimiter=/[^a-zA-Z0-9]+/;dp.qgram_filter=function(e,f,b,a,d){d=d||{};var g=b.q,k=b.words,l=e.length-1-(a-1)*g,p=e.length,m=[],s={},n,t;b=b.gram_position_index;var u=f.length,v,A,x,z=Math.abs,y,B=d.less_than_id;for(d=0;d<u;++d){n=f[d];if(n!==undefined){A=b[n][0];x=b[n][1];for(n=0;n<A.length;++n){t=A[n];if(t!=B&&(!B||t<B)&&z(pos=x[n]-d)<=a){v=s[t];if(v!==-1){y=k[t];if(v===
undefined)v=z(p-y.length)>a?(s[t]=-1):(s[t]=0);if(v!==-1){v=++s[t];if(v>=l&&v>=y.length-1-(a-1)*g){s[t]=-1;dp.levenshtein(e,k[t],a)<=a&&m.push(t)}}}}}}}return m};dp.qgram_dictionary_filter=function(e,f,b){return dp.qgram_filter(e,f.create_gram_index_for_word(e),f,b)};dp.qgram_self_filter=function(e,f,b){return dp.qgram_filter(f.words[e],f.word_to_gram_index[e],f,b,{less_than_id:e})};dp.qgram_self_cluster=function(e,f,b,a){var d,g=[],k=[],l,p;l=e[f].lut;p=e.query({dims:[f],vals:[dv.count("*")],code:false});
d=dp.index.qgram(l,b);l.map(function(m){m=""+m;if(!k[m]){var s=dp.qgram_dictionary_filter(m,d,a);if(s.length>1){var n;s.map(function(u){n||(n=k[l[u]])});if(n)s.map(function(u){if(n.cluster.indexOf(l[u])===-1){n.cluster.push(l[u]);n.counts.push(p[1][u]);n.size++}k[l[u]]=n});else{var t={};t.id=m;t.cluster=s.map(function(u){k[l[u]]=t;return l[u]});t.size=s.length;t.counts=s.map(function(u){return p[1][u]});g.push(t)}}}});return g};dp.outlier={};dp.outlier.zscore=function(e){var f=e.mean,b=e.std,a=[],
d=e.field,g=e.table;e=e.deviations||2;f||a.push(dv.avg(d,{as:"mean"}));b||a.push(dv.stdev(d,{as:"std"}));a=g.query({dims:[],vals:a});f||(f=a.mean[0]);b||(b=a.std[0]);return[f-b*e,f+b*e]};dp.outlier.linear_regression=function(e){var f,b=e.xfield,a=e.yfield,d=e.table;e=d[b];var g=d[a];f=dv.array(e.length);f=[dp.reg_slope(b,a).as("slope"),dp.reg_intercept(b,a).as("intercept")];f=d.query({dims:[],vals:f});b=f.slope[0];a=f.intercept[0];f=dv.array(e.length);for(d=0;d<e.length;++d)f[d]=g[d]-(b*e[d]+a);e=
dv.table([{values:f,name:"residuals",type:dv.numeric}]);return dp.outlier.zscore({table:e,field:"residuals"})};dp.dot=function(e,f,b){b=b||{};var a=dv.op(e,b);a.init=function(){var d={};d[expr]=[a.key];return d};a.done=function(d){return d[a.key]};a.key="dot_"+e+"*"+f;a.value=e;a.map=function(d,g){return d[e][g]*d[f][g]};return a};dp.reg_slope=function(e,f,b){b=b||{};b=dv.op(e,b);b.init=function(){var a={"*":["cnt"]};a[e]=["sum","ssq"];a[f]=["sum"];a["^"]=[dp.dot(e,f)];return a};b.done=function(a){var d=
a.cnt,g=a["sum_"+e],k=a["sum_"+f],l=a["ssq_"+e],p=a[dp.dot(e,f).key];return g.map(function(m,s){return(d*p[s]-g[s]*k[s])/(d*l[s]-g[s]*g[s])})};b.value=e+"*"+f;return b};dp.reg_intercept=function(e,f){o=o||{};var b=dv.op(e,o);b.init=function(){var a={"*":["cnt"]};a[e]=["sum","ssq"];a[f]=["sum"];a["^"]=[dp.dot(e,f)];return a};b.done=function(a){var d=a.cnt,g=a["sum_"+e],k=a["sum_"+f],l=a["ssq_"+e],p=a[dp.dot(e,f).key],m=g.map(function(s,n){return(d*p[n]-g[n]*k[n])/(d*l[n]-g[n]*g[n])});return g.map(function(s,
n){return(k[n]-m[n]*g[n])/d})};b.value=e+"*"+f;return b};dp.outlier.mahalanobis=function(e){var f=e.xfield,b=e.yfield,a=e.table;e=a[f];var d=a[b];dv.array(e.length);result=a.query({dims:[],vals:[dv.avg(f).as("xmean"),dv.avg(b).as("ymean")]});xmean=result.xmean;ymean=result.ymean;xl=e.length;xx=dv.array(xl);xy=dv.array(xl);yy=dv.array(xl);xx.name="xx";yy.name="yy";xy.name="xy";for(f=0;f<xl;++f){a=e[f]-xmean;g=d[f]-ymean;xx[f]=a*a;yy[f]=g*g;xy[f]=a*g}result=dv.table([{values:xx,name:"xx",type:dv.numeric},
{values:xy,name:"xy",type:dv.numeric},{values:yy,name:"yy",type:dv.numeric}]).query({dims:[],vals:[dv.count("*"),dv.sum("xx"),dv.sum("xy"),dv.sum("yy")]});covariance=result.slice(1).map(function(k){return k.map(function(l){return l/(result[0]-1)})});b=covariance[0][0];a=covariance[1][0];g=covariance[2][0];f=b*g-a*covariance[1][0];iul=g/f;ill=iur=-1*a/f;ilr=b/f;b=[];var g;for(f=0;f<xl;++f){a=e[f]-xmean;g=d[f]-ymean;b[f]=(a*iul+g*ill)*a+(a*iur+g*ilr)*g}distance_table=dv.table([{values:b,name:"distance",
type:dv.numeric}]);return dp.outlier.zscore({table:distance_table,field:"distance"})};dp.index={};dp.index.qgram=function(e,f){for(var b=0,a=e.length,d,g,k=Array(a),l,p=[],m={},s=0,n,t=[];b<a;++b){d=e[b];g=d.length;if(g===undefined||g<f)k[b]=[];else{k[b]=Array(g-f+1);for(j=0;j<g-f+1;++j){l=d.substr(j,f);if((n=m[l])===undefined){m[l]=n=s;s++;p[n]=[[],[]];t.push(l)}k[b][j]=n;p[n][0].push(b);p[n][1].push(j)}}}return{create_gram_index_for_word:function(u){var v=u.length,A,x;if(v<f)return[];A=v-f+1;v=
Array(A);for(j=0;j<A;++j){x=u.substr(j,f);v[j]=m[x]}return v},word_to_gram_index:k,gram_position_index:p,gram_lut:t,q:f,words:e}};dp.suggestion={};dp.suggestion.related_variable=function(e){function f(l){var p,m,s=l.length;if(s)for(;--s;){m=Math.floor(Math.random()*(s+1));p=l[m];l[m]=l[s];l[s]=p}return l}function b(){var l,p,m;m=f(d3.range(e.length));console.log(m);m.forEach(function(s){l=e[s];p=l.name();d.add_node(p)});m.forEach(function(s){l=e[s];p=l.name();s<m.length-1&&d.add_edge(p,e[s+1].name())});
console.log("Initial graph");d.debug()}function a(){var l;k=[];e.map(function(p){l=dp.factory.bin().default_bin(e,p);l.unique=l.lut.length;k.push(l);k[p.name()]=l})}var d=dp.graph.sparse(),g,k;b();a();g=dp.graph.search.greedy(d,k,dp.bayes.bde(),dp.graph.move.multi_connected_dag(),{max_moves:300,max_attempts:15E3}).search();g.graph.debug();console.log(g.score)};dp.suggestion.entropy_all=function(e){function f(){var m;b=[];e.map(function(s){m=dp.factory.bin().default_bin(e,s);m.unique=m.lut.length;
b.push(m);b[s.name()]=m;b.type=dt.type;m.binned=true})}var b;f();for(var a=0,d,g=dv.table(),k=[],l,p=[];a<b.length;++a)k.push([]);g.addColumn("dummy",b[0].slice(),"nominal",{encoded:true,lut:b[0].lut});for(a=0;a<b.length-1;++a)for(d=a+1;d<b.length;++d){l=dp.stat.mutual_binned(g,b[a],b[d]);k[a][d]=l;k[d][a]=l;p.push({i:a,j:d,score:l})}p.sort(function(m,s){return m.score<s.score?1:-1});p.map(function(m){console.log(e[m.i].name(),e[m.j].name(),m.score)});return p};dp.add_generated_features=function(e){e.forEach(function(f){if(f.system)return false;
var b=f.type.type();f=f.name();switch(b){case "number":case "int":case "numeric":b=dw.derive.log(dw.derive.variable(f));f=b.name+"("+f+")";var a=e[f];if(!a){a=b.evaluate(e);e.addColumn(f,a,a.type,{system:true,encoded:a.lut!=undefined,lut:a.lut})}break;case "datetime":case "ordinal":break;case "geolocation":case "geo_world":break;case "string":case "nominal":default:break}})};dp.suggestion.entropy=function(e,f,b){function a(){var p;d=[];e.filter(function(m){return g.indexOf(m.name())===-1&&(!m.lut||
m.lut.length<100)}).map(function(m){var s=dp.suggestion.entropy.bin(e,m,f);p=s.bin;p.binner=s.binner;p.unique=f.lut.length;d.push(p);d[m.name()]=p;d.type=dt.type;p.binned=true;p.col=m})}var d,g=b.ignored_columns||[];a();f.binned=true;b=0;var k,l=[];for(b=0;b<d.length;++b){k=dp.stat.normalized_mutual_binned(undefined,f,d[b]);k>0&&l.push({col:d[b].col.name(),score:k,binner:d[b].binner})}l.sort(function(p,m){return p.score>m.score?1:-1});return l};dp.suggestion.entropy.bin=function(e,f,b){e=dp.factory.bin().all_bins(e,
f);var a,d=Infinity,g;b.binned=true;f.name();e.map(function(k){var l=k.bin();l.binned=true;l.unique=l.lut.length;a=dp.stat.normalized_mutual_binned(undefined,b,l);if(f.name()==="Release Date"){console.log(b);console.log(l);console.log(a)}if(a<d){g={binner:k,bin:l,score:a};d=a}});return g};dp.suggestion.missing=function(e){var f,b,a,d;return e.map(function(g){f=b=a=0;g.map(function(k){if(k===dt.MISSING)a++;else if(k===dt.ERROR)b++;else f++});return{col:g.name(),missing:a,error:b,valid:f}}).map(function(g){d=
function(){var k=e[g.col].map(function(l){return l===dt.MISSING?1:0});k.lut=["non-missing","missing"];return k};text=function(){return g.col};return{group:"Missing",col:g.col,bin:d,text:text,entropy:L([g.valid+g.error,g.missing])}}).filter(function(g){return g.entropy!=0}).sort(function(g,k){if(g.col==="Release Location")return 1;if(k.col==="Release Location")return-1;if(g.entropy>k.entropy)return-1;return 1})};dp.suggestion.error=function(e){var f,b,a,d;return e.map(function(g){f=b=a=0;g.map(function(k){if(k===
dt.MISSING)a++;else if(k===dt.ERROR)b++;else f++});return{col:g.name(),missing:a,error:b,valid:f}}).map(function(g){d=function(){var k=e[g.col].map(function(l){return l===dt.ERROR?1:0});k.lut=["non-error","error"];return k};text=function(){return g.col};return{group:"Error",col:g.col,bin:d,text:text,entropy:L([g.valid+g.missing,g.error])}}).filter(function(g){return g.entropy!=0}).sort(function(g,k){if(g.entropy<k.entropy)return-1;return 1})};dp.suggestion.extreme=function(e){var f,b,a,d,g,k,l;return e.filter(function(p){p=
p.type.name();return p==="number"||p==="int"}).map(function(p){g=a=d=0;k=dp.outlier.zscore({table:e,field:p.name(),deviations:1.8});f=k[0];b=k[1];l=[];p.map(function(m){if(m===dt.MISSING||m===dt.ERROR)g++;else if(m>b)d++;else if(m<f)a++;else g++});l.lut=["non-extreme","small","big"];return{col:p.name(),bin:l,big:d,small:a,other:g,min:f,max:b}}).map(function(p){l=function(){var m=p.min,s=p.max,n=e[p.col].map(function(t){return t===dt.MISSING||t===dt.ERROR?0:t>s?2:t<m?1:0});n.lut=["non-extreme","small",
"big"];return n};text=function(){return p.col};return{group:"Extreme",col:p.col,bin:l,text:text,entropy:L([p.other,p.big,p.small])}}).filter(function(p){return p.entropy!=0}).sort(function(p,m){if(p.entropy<m.entropy)return 1;return 1})};dp.suggestion.primary=function(e){return[{col:"Title"}].map(function(f){bin=function(){};text=function(){return f.col};return{group:"Schema",col:f.col,bin:e[f.col],text:text,vis_type:"grouped_bar"}})};dp.median=function(e){e.sort(function(b,a){if(b<a)return-1;if(a<
b)return 1;return 0});var f=e.length;if(f%2)return e[(f-1)/2];return e[f/2]+e[f/2-1]/2};dp.residuals=function(e,f){return e.map(function(b){b=b-f;return b<0?-b:b})};dp.hampel=function(e){var f=dt.MISSING,b=dt.ERROR,a=e.filter(function(d){return d!=f&&d!=b});e=dp.median(a);a=dp.residuals(a,e);a=2.9652*dp.median(a);return[e-a,e+a]};dp.suggestion.hampel=function(e){var f,b,a,d,g,k,l;return e.filter(function(p){p=p.type.name();return p==="number"||p==="int"}).map(function(p){g=a=d=0;k=dp.hampel(e[p.name()]);
f=k[0];b=k[1];l=[];p.map(function(m){if(m===dt.MISSING||m===dt.ERROR)g++;else if(m>b)d++;else if(m<f)a++;else g++});l.lut=["non-extreme","small","big"];return{col:p.name(),bin:l,big:d,small:a,other:g,min:f,max:b}}).map(function(p){l=function(){var m=p.min,s=p.max,n=e[p.col].map(function(t){return t===dt.MISSING||t===dt.ERROR?1:t>s?2:t<m?1:0});n.lut=["non-extreme","small","big"];return n};text=function(){return p.col};routines=["Hampel","z-score"];return{group:"Extreme",routines:routines,col:p.col,
bin:l,text:text,entropy:L([p.other,p.big,p.small])}}).filter(function(p){return p.entropy!=0}).sort(function(p,m){if(p.entropy<m.entropy)return 1;return 1})};dp.suggestion.duplicate=function(e){return e.filter(function(f){return f.type.type()==="nominal"}).map(function(f){return{col:f.name()}}).map(function(f){text=function(){return f.col};return{group:"Inconsistent",routines:["Levenshtein"],data:e,col:f.col,bin:function(){return e[f.col]},text:text,vis_type:"grouped_bar"}})};dp.view.suggestion={};
dp.view.suggestion.text=function(e,f){var b=dw.view.suggestion(e,f);b.update=function(){function a(k){k.append(dv.jq("div").width(120).text("Run Detector").css("text-decoration","underline").click(function(){}));var l=dv.jq("select").attr("id","anomaly_type_select");k.append(l);add_option=function(m,s){dv.add_select_option(l,s,m)};l.change(function(){});["Levenshtein"].forEach(function(m){add_option(m,m)});l=dv.jq("select").attr("id","anomaly_type_select");k.append(l);add_option=function(m,s){dv.add_select_option(l,
s,m)};l.change(function(){});add_option("Radius: 2","Threshold: 3");var p=["2","3","",""];p.forEach(function(m){add_option(m.name,m.name)});k.append(dv.jq("div").width(120).text("Partitions:"));l=dv.jq("select").attr("id","partition_select");k.append(l);add_option=function(m,s){dv.add_select_option(l,s,m)};l.change(function(){});add_option("Column:","Column:");movies_data.forEach(function(m){add_option(m.name,m.name)});l=dv.jq("select").attr("id","partition_select");k.append(l);add_option=function(m,
s){dv.add_select_option(l,s,m)};l.change(function(){});add_option("Group:","Group:");p=["Year","Quarter","Month","Day"];p.forEach(function(m){add_option(m,m)});k.append(dv.jq("div").width(120).text("Add Partition").css("text-decoration","underline"))}var d=b.suggestion(),g=b.vis();if(d){g.append("div").classed("suggestion_title",true).text(d.text());if(d.routines){g.append("div").classed("suggestion_routine",true).text("("+d.routines[0]+")");d=g.append("div").classed("suggestion_menu",true);a(jQuery(d[0]))}}};
return b}})();
